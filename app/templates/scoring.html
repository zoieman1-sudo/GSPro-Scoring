{% extends "base.html" %}
{% block content %}
  <section class="card detail-card scorecard-panel">
    <div class="scorecard-header scorecard-header--simple">
      <div class="scorecard-summary">
        <div class="scorecard-topline">
          <span class="match-chip" id="scorecard-division-chip">Division {{ scorecard.division }}</span>
          <span class="match-chip" id="scorecard-match-chip">Match {{ scorecard.match_key }}</span>
        </div>
        <p class="match-handicaps">
          <span id="scorecard-header-player-a">{{ scorecard.player_a }}</span>
          (hcp <span id="scorecard-header-a-handicap">{{ scorecard.player_a_handicap }}</span>)
          vs
          <span id="scorecard-header-player-b">{{ scorecard.player_b }}</span>
          (hcp <span id="scorecard-header-b-handicap">{{ scorecard.player_b_handicap }}</span>)
        </p>
        {% if status %}
          <div class="status score-status">{{ status }}</div>
        {% endif %}
      </div>
    </div>

    <section
      class="hole-entry-section"
      data-player-a-handicap="{{ scorecard.player_a_handicap }}"
      data-player-b-handicap="{{ scorecard.player_b_handicap }}"
    >
      <div class="setup-head">
        <h2>Hole-by-hole entry</h2>
        <p class="match-sub">Record gross scores for each hole and let the net math happen automatically.</p>
        <div class="hole-player-tags">
          <span class="hole-player-pill" id="hole-player-a-label">{{ scorecard.player_a }}</span>
          <span class="hole-player-pill" id="hole-player-b-label">{{ scorecard.player_b }}</span>
        </div>
      </div>
      <form id="hole-form" class="hole-entry-form">
        <div id="hole-rows" class="hole-inputs"></div>
        <div class="setup-actions">
          <button type="button" id="add-hole-btn" class="add-player-btn">Add hole</button>
        </div>
      </form>
    </section>
  </section>

  <template id="hole-input-template">
      <div class="hole-entry-row">
        <div class="hole-field">
          <label>Hole</label>
          <input type="number" name="hole_number" min="1" placeholder="1" required />
          <label class="hole-hcp-label">HCP</label>
          <input type="number" class="hole-handicap" name="hole_handicap" min="1" max="18" placeholder="—" />
        </div>
        <div class="hole-field">
          <label><span data-hole-label-a>Player A gross</span></label>
          <input type="number" name="player_a_score" min="0" required />
          <small>Net <span data-net-role="a">0</span></small>
          <label class="stroke-flag"><input type="checkbox" name="stroke_a" /> *</label>
        </div>
        <div class="hole-field">
          <label><span data-hole-label-b>Player B gross</span></label>
          <input type="number" name="player_b_score" min="0" required />
          <small>Net <span data-net-role="b">0</span></small>
          <label class="stroke-flag"><input type="checkbox" name="stroke_b" /> *</label>
        </div>
      <div class="hole-diff">
        <label>Net diff</label>
        <span data-diff-role>0</span>
      </div>
    </div>
  </template>

  <script>
    const divisionChip = document.getElementById("scorecard-division-chip");
    const matchChip = document.getElementById("scorecard-match-chip");
    const headerPlayerAName = document.getElementById("scorecard-header-player-a");
    const headerPlayerBName = document.getElementById("scorecard-header-player-b");
    const headerAHandicap = document.getElementById("scorecard-header-a-handicap");
    const headerBHandicap = document.getElementById("scorecard-header-b-handicap");
    const holePlayerALabel = document.getElementById("hole-player-a-label");
    const holePlayerBLabel = document.getElementById("hole-player-b-label");
    const strokeSummary = document.getElementById("stroke-summary");
    const divisionTitle = document.getElementById("scorecard-division");
    const keyTitle = document.getElementById("scorecard-match-key");
    const entrySection = document.querySelector(".hole-entry-section");
    const holeContainer = document.getElementById("hole-rows");
    const template = document.getElementById("hole-input-template");
    const standardHoleCount = 18;

    const updateStrokeSummary = (handicapA, handicapB) => {
      if (!strokeSummary) return;
      const diff = handicapA - handicapB;
      if (diff === 0) {
        strokeSummary.textContent = "Strokes: none allocated";
        return;
      }
      const receiver = diff > 0 ? (holePlayerBLabel?.textContent || "Player B") : (holePlayerALabel?.textContent || "Player A");
      const strokes = Math.abs(diff);
      strokeSummary.textContent = `${receiver} gets ${strokes} stroke${strokes === 1 ? "" : "s"} total`;
    };

    const updateScorecard = (summary) => {
      if (divisionChip) {
        divisionChip.textContent = `Division ${summary.division || "A"}`;
      }
      if (matchChip) {
        matchChip.textContent = `Match ${summary.match_key || ""}`;
      }
      if (headerPlayerAName) {
        headerPlayerAName.textContent = summary.player_a;
      }
      if (headerPlayerBName) {
        headerPlayerBName.textContent = summary.player_b;
      }
      if (headerAHandicap) {
        headerAHandicap.textContent = summary.player_a_handicap;
      }
      if (headerBHandicap) {
        headerBHandicap.textContent = summary.player_b_handicap;
      }
      if (divisionTitle) {
        divisionTitle.textContent = summary.division || "Open";
      }
      if (keyTitle) {
        keyTitle.textContent = summary.match_key || "";
      }
      if (holePlayerALabel) {
        holePlayerALabel.textContent = summary.player_a;
      }
      if (holePlayerBLabel) {
        holePlayerBLabel.textContent = summary.player_b;
      }
      updateStrokeSummary(Number(summary.player_a_handicap), Number(summary.player_b_handicap));
      if (entrySection) {
        entrySection.dataset.playerAHandicap = summary.player_a_handicap;
        entrySection.dataset.playerBHandicap = summary.player_b_handicap;
        entrySection.dataset.matchKey = summary.match_key;
        renderHoleEntryRows(summary.holes);
      }
    };

    const netAdjustment = (handicap, holeNumber) => {
      const base = Math.floor(handicap / 18);
      const remainder = handicap % 18;
      const extra = remainder && holeNumber <= remainder ? 1 : 0;
      return base + extra;
    };

    const updateRow = (row) => {
      const holeInput = row.querySelector('input[name="hole_number"]');
      const aInput = row.querySelector('input[name="player_a_score"]');
      const bInput = row.querySelector('input[name="player_b_score"]');
      const labelA = row.querySelector("[data-hole-label-a]");
      const labelB = row.querySelector("[data-hole-label-b]");
      if (labelA) {
        labelA.textContent = holePlayerALabel?.textContent
          ? `${holePlayerALabel.textContent} gross`
          : "Player A gross";
      }
      if (labelB) {
        labelB.textContent = holePlayerBLabel?.textContent
          ? `${holePlayerBLabel.textContent} gross`
          : "Player B gross";
      }
      const holeNumber = Number(holeInput.value) || Number(row.dataset.defaultHole) || 1;
      const netA =
        aInput.value !== ""
          ? Number(aInput.value) - netAdjustment(Number(entrySection.dataset.playerAHandicap), holeNumber)
          : null;
      const netB =
        bInput.value !== ""
          ? Number(bInput.value) - netAdjustment(Number(entrySection.dataset.playerBHandicap), holeNumber)
          : null;
      const netSpanA = row.querySelector('[data-net-role="a"]');
      const netSpanB = row.querySelector('[data-net-role="b"]');
      const diffSpan = row.querySelector('[data-diff-role]');
      if (netSpanA) {
        netSpanA.textContent = netA !== null ? netA : "—";
      }
      if (netSpanB) {
        netSpanB.textContent = netB !== null ? netB : "—";
      }
      if (diffSpan) {
        diffSpan.textContent = netA !== null && netB !== null ? netA - netB : "—";
      }
    };

    const bindRow = (row) => {
      row.querySelectorAll("input").forEach((input) => {
        input.addEventListener("input", () => {
          updateRow(row);
        });
      });
      updateRow(row);
    };

    const addHoleRow = (holeNumber = "", data = null) => {
      if (!template || !holeContainer) {
        return;
      }
      const clone = template.content.cloneNode(true);
      const row = clone.querySelector(".hole-entry-row");
      const holeInput = row.querySelector('input[name="hole_number"]');
      const aInput = row.querySelector('input[name="player_a_score"]');
      const bInput = row.querySelector('input[name="player_b_score"]');
      const hcpInput = row.querySelector('input[name="hole_handicap"]');
      const strokeA = row.querySelector('input[name="stroke_a"]');
      const strokeB = row.querySelector('input[name="stroke_b"]');
      if (data) {
        holeInput.value = data.hole_number || holeNumber;
        aInput.value = data.player_a_score;
        bInput.value = data.player_b_score;
        row.dataset.defaultHole = data.hole_number;
        if (hcpInput && data.hole_handicap) {
          hcpInput.value = data.hole_handicap;
        }
        if (strokeA && data.stroke_a) {
          strokeA.checked = Boolean(data.stroke_a);
        }
        if (strokeB && data.stroke_b) {
          strokeB.checked = Boolean(data.stroke_b);
        }
      } else {
        holeInput.value = holeNumber || "";
        row.dataset.defaultHole = holeInput.value || holeNumber || "";
      }
      holeContainer.appendChild(row);
      bindRow(row);
    };

    const renderHoleEntryRows = (holes = []) => {
      if (!holeContainer) {
        return;
      }
      const holeData = {};
      holes.forEach((hole) => {
        const number = Number(hole.hole_number) || 0;
        if (number > 0) {
          holeData[number] = hole;
        }
      });
      holeContainer.innerHTML = "";
      for (let holeNumber = 1; holeNumber <= standardHoleCount; holeNumber += 1) {
        addHoleRow(holeNumber, holeData[holeNumber]);
      }
      holes
        .filter((hole) => Number(hole.hole_number) > standardHoleCount)
        .forEach((hole) => addHoleRow(Number(hole.hole_number), hole));
    };

    updateScorecard({{ scorecard | tojson }});

    const addHoleButton = document.getElementById("add-hole-btn");
    const saveHolesButton = document.getElementById("save-holes-btn");

    if (addHoleButton) {
      addHoleButton.addEventListener("click", () => addHoleRow());
    }

    if (saveHolesButton) {
      saveHolesButton.addEventListener("click", async () => {
        if (!holeContainer || !entrySection) {
          return;
        }
        const rows = Array.from(holeContainer.querySelectorAll(".hole-entry-row"))
          .map((row) => {
            const holeInput = row.querySelector('input[name="hole_number"]');
            const aInput = row.querySelector('input[name="player_a_score"]');
            const bInput = row.querySelector('input[name="player_b_score"]');
            if (!holeInput || !aInput || !bInput) {
              return null;
            }
            if (!row.dataset.defaultHole && !holeInput.value) {
              return null;
            }
            return {
              hole_number: holeInput.value || row.dataset.defaultHole,
              player_a_score: aInput.value,
              player_b_score: bInput.value,
              hole_handicap: row.querySelector('input[name="hole_handicap"]')?.value || "",
              stroke_a: row.querySelector('input[name="stroke_a"]')?.checked || false,
              stroke_b: row.querySelector('input[name="stroke_b"]')?.checked || false,
            };
          })
          .filter(
            (entry) => entry && entry.player_a_score !== "" && entry.player_b_score !== ""
          );
        if (!rows.length) {
          return;
        }
        const response = await fetch(`/matches/${entrySection.dataset.matchKey}/holes`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ holes: rows }),
        });
        if (response.ok) {
          const summaryResponse = await fetch(`/api/match-summary/${entrySection.dataset.matchKey}`);
          if (summaryResponse.ok) {
            const data = await summaryResponse.json();
            updateScorecard(data);
          }
        }
      });
    }
  </script>

{% endblock %}
