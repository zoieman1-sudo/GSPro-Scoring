{% extends "base.html" %}

{% block content %}
  <section class="card">
    <div class="match-meta">
      <p class="eyebrow">Group Management</p>
      <h1 class="match-title">Match Group Builder</h1>
    </div>
    <form action="/admin/match_setup" method="post" class="setup-form">
      {% if editable_match %}
        <input type="hidden" name="match_id" value="{{ editable_match.id }}" />
      {% endif %}
      <div class="match-setup__intro">
        <div class="match-setup__add-players">
          <p class="eyebrow">Group builder</p>
          <h1 class="match-title">Match Group Setup</h1>
          <p class="muted-label">Pick the course and pair two head-to-head matches to form the group.</p>
          <a class="pill-link" href="/admin/player_entry">Player entry</a>
        </div>
        <label>
          Tournament
          <select name="tournament_id" required>
            {% for tournament in tournaments %}
              <option value="{{ tournament.id }}" {% if tournament.id == active_tournament_id %}selected{% endif %}>
                {{ tournament.name }}
              </option>
            {% endfor %}
          </select>
        </label>
      </div>
      <div class="group-builder__course form-row">
        <label>
          Course
          <select name="course_id">
            <option value="">-- Choose course --</option>
            {% for course in course_catalog %}
              <option
                value="{{ course.id }}"
                {% if editable_match and editable_match.course_id == course.id %}selected{% endif %}
              >
                {{ course.club_name }} — {{ course.course_name }}
              </option>
            {% endfor %}
          </select>
        </label>
        <label>
          Tee
          <select name="course_tee_id">
            <option value="">-- Choose tee --</option>
            {% for course in course_catalog %}
              {% for tee in course.tees %}
                <option
                  value="{{ tee.id }}"
                  {% if editable_match and editable_match.course_tee_id == tee.id %}selected{% endif %}
                >
                  {{ course.course_name }} — {{ tee.tee_name }}
                </option>
              {% endfor %}
            {% endfor %}
          </select>
        </label>
      </div>
      <div class="group-builder__match" aria-label="Match 1">
        <p class="muted-label">Player A vs Player B</p>
        <div class="form-row form-row--compact">
          <label>
            Player A
            <select name="player_a_id" required>
              {% for player in players %}
                <option value="{{ player.id }}" {% if editable_match and editable_match.player_a_id == player.id %}selected{% endif %}>
                  {{ player.name }}
                </option>
              {% endfor %}
            </select>
          </label>
          <label>
            Player B
            <select name="player_b_id" required>
              {% for player in players %}
                <option value="{{ player.id }}" {% if editable_match and editable_match.player_b_id == player.id %}selected{% endif %}>
                  {{ player.name }}
                </option>
              {% endfor %}
            </select>
          </label>
        </div>
      </div>
      <div class="group-builder__match" aria-label="Match 2">
        <p class="muted-label">Player C vs Player D</p>
        <div class="form-row form-row--compact">
        <label>
          Player C
          <select name="player_c_id" required>
            <option value="">Select player C</option>
            {% for player in players %}
              <option value="{{ player.id }}" {% if editable_match and editable_match.player_c_id == player.id %}selected{% endif %}>
                {{ player.name }}
              </option>
            {% endfor %}
          </select>
        </label>
        <label>
          Player D
          <select name="player_d_id" required>
            <option value="">Select player D</option>
            {% for player in players %}
              <option value="{{ player.id }}" {% if editable_match and editable_match.player_d_id == player.id %}selected{% endif %}>
                {{ player.name }}
              </option>
            {% endfor %}
          </select>
        </label>
      </div>
    </div>
      <div class="form-row">
        <label>
          Division
          <input
            type="text"
            name="division"
            required
            value="{{ editable_match.division if editable_match else 'A' }}"
          />
        </label>
        <label>
          Holes
          <input
            type="number"
            name="hole_count"
            min="9"
            max="18"
            value="{{ editable_match.hole_count if editable_match else 18 }}"
          />
        </label>
        <label>
          Active
          <input
            type="checkbox"
            name="active"
            value="1"
            {% if editable_match and editable_match.active %}checked{% endif %}
          />
        </label>
      </div>
      <p class="muted-label">Match key is generated automatically when the group is saved.</p>
      <button type="submit" class="submit-btn">
        {{ "Update match" if editable_match else "Save match" }}
      </button>
      {% if editable_match %}
        <a href="/admin/match_setup?tournament_id={{ active_tournament_id }}" class="pill-link">
          Cancel edit
        </a>
      {% endif %}
      {% if status %}
        <p class="muted-label">{{ status }}</p>
      {% endif %}
    </form>
  </section>
{% endblock %}

{% block scripts %}
  <script>
    const matchSetupTournamentSelect = document.querySelector(
      'form.setup-form select[name="tournament_id"]'
    );
    if (matchSetupTournamentSelect) {
      matchSetupTournamentSelect.addEventListener("change", (event) => {
        const select = event.target;
        const params = new URLSearchParams(window.location.search);
        params.set("tournament_id", select.value);
        if (params.has("edit_match_id") && select.value !== "{{ active_tournament_id }}") {
          params.delete("edit_match_id");
        }
        window.location.search = params.toString();
      });
    }
  </script>
{% endblock %}
