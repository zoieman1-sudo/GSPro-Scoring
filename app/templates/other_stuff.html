{% extends "base.html" %}
{% block content %}
  <section class="new-card-shell">
    <style>
      .match-grid {
        display: flex;
        justify-content: center;
      }

      .match-card {
        border-radius: var(--radius-lg);
        border: 1px solid rgba(255, 255, 255, 0.12);
        width: min(1120px, 100%);
        background: rgba(3, 8, 20, 0.9);
        box-shadow: 0 50px 100px rgba(0, 0, 0, 0.7);
      }

      .match-info {
        background: linear-gradient(135deg, rgba(16, 44, 90, 0.95), rgba(6, 17, 40, 0.92));
        border-radius: var(--radius-lg) var(--radius-lg) 0 0;
        padding: 36px 40px;
        display: flex;
        align-items: center;
        gap: 12px;
        justify-content: space-between;
        flex-wrap: wrap;
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      }

      .match-info__left {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .match-info__left strong {
        text-transform: uppercase;
        letter-spacing: 0.4em;
        font-size: 0.75rem;
        color: rgba(255, 255, 255, 0.65);
      }

      .match-info__left h1 {
        margin: 0;
        font-size: 1.3rem;
        font-weight: 500;
      }

      .match-info__mid {
        font-size: 0.85rem;
        letter-spacing: 0.2em;
        text-transform: uppercase;
        color: rgba(255, 255, 255, 0.6);
        margin-bottom: 4px;
      }

      .ghost-btn.match-select-button {
        border: 1px solid rgba(255, 255, 255, 0.4);
        padding: 10px 20px;
        background: rgba(255, 255, 255, 0.05);
        color: white;
        border-radius: var(--radius-pill);
        text-transform: uppercase;
        letter-spacing: 0.3em;
        font-size: 0.75rem;
        transition: background 0.2s ease, border-color 0.2s ease;
      }

      .ghost-btn.match-select-button:hover {
        background: rgba(255, 255, 255, 0.25);
        border-color: rgba(67, 225, 255, 0.8);
      }

      .horizontal-score-table {
        background: linear-gradient(180deg, rgba(8, 18, 44, 0.88), rgba(3, 8, 20, 0.9));
        border-radius: var(--radius-lg);
        border: 1px solid rgba(255, 255, 255, 0.12);
        padding: 30px 32px;
        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.03), 0 30px 65px rgba(0, 0, 0, 0.6);
        display: flex;
        flex-direction: column;
        gap: 18px;
        width: 100%;
        min-height: 320px;
      }

      .scoreboard-stack {
        display: flex;
        flex-direction: column;
        gap: 16px;
        width: 100%;
      }

      .scoreboard-empty {
        text-transform: uppercase;
        letter-spacing: 0.35em;
        font-size: 0.72rem;
        color: rgba(255, 255, 255, 0.55);
        text-align: center;
      }

      .scoreboard-card {
        background: rgba(4, 9, 20, 0.95);
        border-radius: var(--radius-lg);
        padding: 18px 22px 22px;
        border: 1px solid rgba(255, 255, 255, 0.08);
        box-shadow: 0 18px 60px rgba(0, 0, 0, 0.45);
        width: 100%;
        display: flex;
        flex-direction: column;
        gap: 12px;
        min-height: 240px;
      }

      .scoreboard-card--active {
        border-color: rgba(72, 227, 255, 0.75);
        box-shadow: 0 20px 60px rgba(72, 227, 255, 0.25);
      }

      .scoreboard-card--empty {
        justify-content: center;
        align-items: center;
        font-size: 0.75rem;
        color: rgba(255, 255, 255, 0.4);
        min-height: 200px;
      }

      .scoreboard-card__header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 12px;
      }

      .scoreboard-card__meta {
        display: flex;
        gap: 8px;
        font-size: 0.65rem;
        letter-spacing: 0.2em;
        text-transform: uppercase;
        color: rgba(255, 255, 255, 0.6);
        margin-top: 4px;
      }

      .scoreboard-card__matchkey {
        display: flex;
        gap: 6px;
        align-items: center;
      }

      .scoreboard-card__launch,
      .scoreboard-card__matchkey span {
        display: inline-flex;
        align-items: center;
      }

      .scoreboard-card__launch {
        margin-top: 6px;
        align-self: flex-start;
        padding: 8px 12px;
        border-radius: var(--radius-pill);
        border: 1px solid rgba(255, 255, 255, 0.2);
        background: rgba(67, 225, 255, 0.15);
        color: #fff;
        font-size: 0.7rem;
        letter-spacing: 0.3em;
        text-transform: uppercase;
        text-decoration: none;
        transition: background 0.2s ease, border-color 0.2s ease;
      }

      .scoreboard-card__launch:hover {
        background: rgba(67, 225, 255, 0.35);
        border-color: rgba(67, 225, 255, 0.8);
      }

      .scoreboard-card--group {
        background: linear-gradient(145deg, rgba(4, 11, 24, 0.95), rgba(8, 20, 40, 0.95));
      }

      .scoreboard-card__group-body {
        border-radius: var(--radius-md);
        border: 1px solid rgba(255, 255, 255, 0.08);
        padding: 12px;
        background: rgba(255, 255, 255, 0.02);
        display: flex;
        flex-direction: column;
        gap: 18px;
      }

      .scoreboard-card__match-block {
        border-radius: var(--radius-md);
        padding: 14px;
        border: 1px solid rgba(255, 255, 255, 0.06);
        background: rgba(0, 0, 0, 0.35);
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .scoreboard-card__match-block--active {
        border-color: rgba(67, 225, 255, 0.8);
        box-shadow: 0 0 0 2px rgba(67, 225, 255, 0.2);
      }

      .scoreboard-card__match-block-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
      }

      .scoreboard-card__match-block-labels {
        text-transform: uppercase;
        letter-spacing: 0.3em;
        font-size: 0.65rem;
        color: rgba(255, 255, 255, 0.6);
      }

      .scoreboard-card__grid--match-block {
        gap: 10px;
      }

      .scoreboard-card__division {
        text-transform: uppercase;
        letter-spacing: 0.3em;
        font-size: 0.65rem;
        color: rgba(255, 255, 255, 0.65);
        display: block;
      }

      .scoreboard-card__matchup {
        margin: 4px 0 0;
        font-size: 1rem;
        font-weight: 600;
        letter-spacing: 0.1em;
        text-transform: uppercase;
      }

      .scoreboard-card__status {
        font-size: 0.65rem;
        letter-spacing: 0.4em;
        text-transform: uppercase;
        color: rgba(255, 255, 255, 0.5);
      }

      .scoreboard-card__grid {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .scoreboard-card__row-group {
        border-radius: var(--radius-md);
        border: 1px solid rgba(255, 255, 255, 0.08);
        background: rgba(255, 255, 255, 0.02);
        padding: 10px 12px;
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      .scoreboard-card__row-group .scoreboard-card__row {
        font-size: 0.65rem;
        color: rgba(255, 255, 255, 0.65);
      }

      .scoreboard-card__row-group-label {
        font-size: 0.65rem;
        letter-spacing: 0.4em;
        text-transform: uppercase;
        margin-bottom: 4px;
        color: rgba(255, 255, 255, 0.6);
      }

      .scoreboard-card__row-group--player {
        background: rgba(14, 29, 54, 0.85);
        border: 1px solid rgba(255, 255, 255, 0.12);
        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.03);
      }

      .scoreboard-card__row {
        display: grid;
        grid-template-columns: 120px repeat(9, minmax(26px, 1fr)) 70px;
        gap: 6px;
        align-items: center;
        font-size: 0.75rem;
        color: rgba(255, 255, 255, 0.9);
      }

      .scoreboard-card__row-label {
        letter-spacing: 0.35em;
        text-transform: uppercase;
        font-size: 0.6rem;
        color: rgba(255, 255, 255, 0.55);
      }

      .scoreboard-card__row-text {
        display: inline-block;
      }

      .scoreboard-card__row-value {
        text-align: center;
        font-size: 0.85rem;
        font-weight: 600;
      }

      .scoreboard-card__row-total {
        text-align: center;
        letter-spacing: 0.35em;
        font-size: 0.7rem;
        color: rgba(255, 255, 255, 0.55);
      }

      .scoreboard-card__stroke-indicator {
        font-size: 0.65rem;
        margin-left: 4px;
        letter-spacing: 0.1em;
        color: rgba(255, 255, 255, 0.6);
      }

      .scoreboard-card__row--holes .scoreboard-card__row-value {
        font-size: 0.7rem;
        font-weight: 500;
        color: rgba(255, 255, 255, 0.65);
      }

      .scoreboard-card__row--par .scoreboard-card__row-value {
        color: rgba(255, 255, 255, 0.65);
      }

      .scoreboard-card__row--hcp .scoreboard-card__row-value {
        color: rgba(255, 255, 255, 0.55);
      }

      .scoreboard-card__row--gross .scoreboard-card__row-value,
      .scoreboard-card__row--net .scoreboard-card__row-value {
        font-size: 0.95rem;
      }

      .scoreboard-card__row--status .scoreboard-card__row-value {
        font-weight: 700;
        text-transform: uppercase;
        color: rgba(255, 255, 255, 0.75);
      }

      .scoreboard-card__row--net {
        border-top: 1px dashed rgba(255, 255, 255, 0.15);
        padding-top: 8px;
      }

      .match-modal {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.7);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 40;
        padding: 20px;
      }

      .match-modal.active {
        display: flex;
      }

      .match-modal__content {
        background: rgba(2, 6, 18, 0.98);
        border-radius: var(--radius-lg);
        padding: 32px;
        width: min(1160px, 98vw);
        border: 1px solid rgba(255, 255, 255, 0.12);
        max-height: 85vh;
        overflow: hidden;
      }

      .match-modal__header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
      }

      .match-modal__body {
        max-height: calc(75vh - 80px);
        overflow-y: auto;
        padding-right: 8px;
      }

      .match-modal__grid {
        display: grid;
        grid-template-columns: repeat(3, minmax(220px, 1fr));
        gap: 14px;
      }

      .match-modal__item {
        border-radius: var(--radius-pill);
        border: 1px solid rgba(255, 255, 255, 0.2);
        background: rgba(26, 40, 74, 0.85);
        padding: 12px 18px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
        cursor: pointer;
        color: #fff;
      }

      .match-modal__item:hover {
        border-color: rgba(67, 225, 255, 0.6);
        background: rgba(67, 225, 255, 0.12);
      }

      .match-modal__item--active {
        border-color: rgba(67, 225, 255, 0.8);
        background: rgba(67, 225, 255, 0.18);
      }

      @media (max-width: 960px) {
        .match-modal__grid {
          grid-template-columns: repeat(2, minmax(200px, 1fr));
        }
      }

      @media (max-width: 640px) {
        .match-modal__grid {
          grid-template-columns: repeat(1, minmax(220px, 1fr));
        }
      }

      .match-modal__grid-item {
        position: relative;
        border-radius: var(--radius-md);
        border: 1px solid rgba(255, 255, 255, 0.15);
        background: rgba(255, 255, 255, 0.02);
        padding: 18px 20px;
        display: flex;
        flex-direction: column;
        gap: 6px;
        cursor: pointer;
        font-size: 0.75rem;
        min-height: 130px;
      }

      .match-modal__grid-item.active,
      .match-modal__grid-item--selected {
        border-color: rgba(72, 227, 255, 0.7);
        background: rgba(72, 227, 255, 0.12);
      }

      .match-modal__checkbox {
        position: absolute;
        top: 14px;
        right: 14px;
        width: 20px;
        height: 20px;
      }

      .match-modal__grid-row {
        line-height: 1.3;
      }

      .match-modal__division {
        letter-spacing: 0.3em;
        text-transform: uppercase;
        font-weight: 600;
        font-size: 0.65rem;
        color: rgba(255, 255, 255, 0.8);
      }

      .match-modal__matchup {
        font-size: 0.8rem;
        letter-spacing: 0.2em;
        color: rgba(255, 255, 255, 0.9);
      }

      .match-modal__status {
        font-size: 0.65rem;
        letter-spacing: 0.35em;
        text-transform: uppercase;
        color: rgba(255, 255, 255, 0.55);
      }

      .match-modal__controls {
        margin-top: 18px;
        display: flex;
        justify-content: flex-end;
      }

      .match-modal__controls .ghost-btn {
        padding: 12px 20px;
      }

      .muted-label {
        color: rgba(255, 255, 255, 0.6);
        font-size: 0.78rem;
        text-transform: uppercase;
        letter-spacing: 0.3em;
      }

    </style>

    <section class="match-grid">
      <article class="card match-card" id="studio-match-card">
          <div class="match-info" id="studio-match-info">
            <div class="match-info__left">
              <strong id="match-info-label">Match A</strong>
              <span id="match-info-matchup">Player 1 vs Player 2</span>
            </div>
            <div class="match-info__mid">
              <span id="match-info-status">Status: Not started</span>
            </div>
            <button class="ghost-btn match-select-button" id="open-match-modal">Select match</button>
          </div>
        <div class="horizontal-score-table" id="studio-match-table"></div>
      </article>
    </section>

    <div class="match-modal" id="match-modal">
      <div class="match-modal__content">
        <div class="match-modal__header">
          <h3>Choose match</h3>
          <button class="ghost-btn" id="match-modal-close">Close</button>
        </div>
        <div class="match-modal__body">
          <div class="match-modal__grid" id="match-modal-grid"></div>
        </div>
        <div class="match-modal__controls">
          <button class="ghost-btn" id="match-modal-save">Select / Save</button>
        </div>
      </div>
    </div>

  </section>
  <script>
    const phaseOrder = { not_started: 0, in_progress: 1, completed: 2 };
    const phaseLabels = {
      not_started: "Not started",
      in_progress: "In progress",
      completed: "Finished",
    };
    const seededMatches = {{ matches_listing | tojson }};
    const fallbackMatches = [
      {
        match_key: "studio-match-a",
        label: "Match A",
        display: "Match A",
        division: "Division B",
        summary: "Match A features Player 1 vs Player 2 on the four-person template.",
        matchup: "Player 1 vs Player 2",
        status: "in_progress",
        status_label: "In progress",
        phase: "in_progress",
        holes: [
          { hole_number: 1, par: 4, handicap: 5, player_scores: [{ gross: 4, net: 3 }, { gross: 5, net: 4 }], winner: "Player 1" },
          { hole_number: 2, par: 5, handicap: 1, player_scores: [{ gross: 5, net: 4 }, { gross: 4, net: 3 }], winner: "Player 2" },
          { hole_number: 3, par: 3, handicap: 9, player_scores: [{ gross: 3, net: 2 }, { gross: 5, net: 4 }], winner: "Player 1" },
          { hole_number: 4, par: 4, handicap: 3, player_scores: [{ gross: 5, net: 4 }, { gross: 4, net: 3 }], winner: "Player 2" },
          { hole_number: 5, par: 4, handicap: 2, player_scores: [{ gross: 4, net: 3 }, { gross: 5, net: 4 }], winner: "Player 1" },
          { hole_number: 6, par: 4, handicap: 6, player_scores: [{ gross: 5, net: 4 }, { gross: 5, net: 4 }], winner: "AS" },
          { hole_number: 7, par: 3, handicap: 7, player_scores: [{ gross: 3, net: 2 }, { gross: 3, net: 2 }], winner: "AS" },
          { hole_number: 8, par: 5, handicap: 4, player_scores: [{ gross: 5, net: 4 }, { gross: 4, net: 3 }], winner: "Player 2" },
          { hole_number: 9, par: 4, handicap: 8, player_scores: [{ gross: 4, net: 3 }, { gross: 4, net: 3 }], winner: "AS" },
        ],
        players: [
          { name: "Player 1", course_handicap: 12, role: "A" },
          { name: "Player 2", course_handicap: 13, role: "B" },
        ],
        meta: { stroke_owner: "A", stroke_count: 0 },
        course: {
          course_name: "Cedar Ridge",
          tee_name: "Summit Ridge",
          total_yards: 3254,
          course_rating: "67.2",
          slope_rating: "125",
        },
      },
      {
        match_key: "studio-match-b",
        label: "Match B",
        division: "Division A",
        display: "Match B",
        summary: "Match B pits Player 3 against Player 4 from the same 4-person scorecard.",
        matchup: "Player 3 vs Player 4",
        status: "not_started",
        status_label: "Not started",
        phase: "not_started",
        holes: [
          { hole_number: 1, par: 4, handicap: 5, player_scores: [{ gross: 4, net: 3 }, { gross: 5, net: 4 }], winner: "Player 3" },
          { hole_number: 2, par: 5, handicap: 1, player_scores: [{ gross: 5, net: 4 }, { gross: 6, net: 5 }], winner: "Player 3" },
          { hole_number: 3, par: 3, handicap: 9, player_scores: [{ gross: 4, net: 3 }, { gross: 3, net: 2 }], winner: "Player 4" },
          { hole_number: 4, par: 4, handicap: 3 },
          { hole_number: 5, par: 4, handicap: 2 },
          { hole_number: 6, par: 4, handicap: 6 },
          { hole_number: 7, par: 3, handicap: 7 },
          { hole_number: 8, par: 5, handicap: 4 },
          { hole_number: 9, par: 4, handicap: 8 },
        ],
        players: [
          { name: "Player 3", course_handicap: 9, role: "A" },
          { name: "Player 4", course_handicap: 15, role: "B" },
        ],
        meta: { stroke_owner: null, stroke_count: 0 },
        course: {
          course_name: "Cedar Ridge",
          tee_name: "Summit Ridge",
          total_yards: 3254,
          course_rating: "67.2",
          slope_rating: "125",
        },
      },
    ];

    const urlParams = new URLSearchParams(window.location.search);
    const requestedGroupKey = urlParams.get("group_key") || "";
    let groupDefinitions = [];
    let selectedGroupKey = "";

    const holeReference = {{ hole_reference | tojson }};
    const defaultHoleTemplate = holeReference.length
      ? holeReference
      : Array.from({ length: 9 }, (_, idx) => ({
          hole_number: idx + 1,
          par: null,
          handicap: null,
        }));
    const matchTableEl = document.getElementById("studio-match-table");
    const holeRefHoleRow = document.getElementById("hole-ref-hole-row");
    const holeRefParRow = document.getElementById("hole-ref-par-row");
    const holeRefHcpRow = document.getElementById("hole-ref-hcp-row");
    const modal = document.getElementById("match-modal");
    const matchModalGrid = document.getElementById("match-modal-grid");
    const matchModalSave = document.getElementById("match-modal-save");
    const modalClose = document.getElementById("match-modal-close");
    const openModalBtn = document.getElementById("open-match-modal");
    const maxSelectableMatches = 2;
    let sortedMatches = [];
    let selectedMatchKeys = new Set();

    const formatValue = (value) => {
      if (value === null || value === undefined || value === "") {
        return "—";
      }
      return value;
    };

    const parseNumericValue = (value) => {
      if (value === null || value === undefined || value === "") {
        return null;
      }
      const parsed = Number(value);
      return Number.isFinite(parsed) ? parsed : null;
    };

    const sumNumeric = (values) =>
      values.reduce((total, value) => {
        const numeric = parseNumericValue(value);
        return numeric === null ? total : total + numeric;
      }, 0);

    const getStrokeIndicatorSymbol = (player, meta) => {
      if (!player || !player.role || !meta) {
        return "";
      }
      if (meta.stroke_owner !== player.role) {
        return "";
      }
      const strokes = parseNumericValue(meta.stroke_count);
      if (!strokes || strokes <= 0) {
        return "";
      }
      if (Math.abs(strokes - 0.5) < 0.01) {
        return "½";
      }
      return "*";
    };

    const computeMatchStatusProgress = (holeRows) => {
      const statuses = [];
      let lead = 0;
      holeRows.forEach((hole) => {
        const scores = hole.player_scores || [];
        const aScore = parseNumericValue(scores[0]?.gross);
        const bScore = parseNumericValue(scores[1]?.gross);
        let winner = 0;
        if (aScore !== null && bScore !== null) {
          if (aScore < bScore) {
            winner = 1;
          } else if (aScore > bScore) {
            winner = -1;
          }
        }
        lead += winner;
        statuses.push(formatMatchLead(lead));
      });
      return statuses;
    };

    const computeMatchStatusSymbol = (match) => {
      const holeRows = buildHoleRows(match);
      const statuses = computeMatchStatusProgress(holeRows);
      return statuses[statuses.length - 1] || "A/S";
    };

    const formatMatchLead = (lead) => {
      if (lead === 0) {
        return "A/S";
      }
      const absolute = Math.abs(lead);
      const text = `${absolute} ${lead > 0 ? "UP" : "DN"}`;
      return text;
    };

    const buildStatusRow = (statuses) => {
      if (!statuses.length) {
        return "";
      }
      const cells = statuses
        .map((value) => {
          const className =
            value === "A/S"
              ? "scoreboard-card__status-value--neutral"
              : value.includes("UP")
              ? "scoreboard-card__status-value--up"
              : "scoreboard-card__status-value--down";
          return `<span class="scoreboard-card__row-value scoreboard-card__status-value ${className}">${value}</span>`;
        })
        .join("");
      const total = statuses[statuses.length - 1] || "A/S";
      return `
        <div class="scoreboard-card__row scoreboard-card__row--status">
          <span class="scoreboard-card__row-label">
            <span class="scoreboard-card__row-text">Match status</span>
          </span>
          ${cells}
          <span class="scoreboard-card__row-total">${total}</span>
        </div>
      `;
    };

    const buildHoleRows = (match) => {
      const holesSource = match?.holes?.length ? match.holes : defaultHoleTemplate;
      const playerCount = Math.max(match?.players?.length || 2, 2);
      return holesSource.map((hole) => {
        const rawScores = Array.isArray(hole.player_scores) ? hole.player_scores : [];
        const player_scores = Array.from({ length: playerCount }, (_, index) => {
          const base = rawScores[index] || {};
          return { gross: base.gross ?? null, net: base.net ?? null };
        });
        return {
          hole_number: hole.hole_number,
          par: hole.par,
          handicap: hole.handicap,
          player_scores,
        };
      });
    };

    const buildRow = (label, values, total, modifier, indicator = "") => {
      const cells = values
        .map((value) => `<span class="scoreboard-card__row-value">${formatValue(value)}</span>`)
        .join("");
      return `
        <div class="scoreboard-card__row scoreboard-card__row--${modifier}">
          <span class="scoreboard-card__row-label">
            <span class="scoreboard-card__row-text">${label}</span>
            ${indicator ? `<span class="scoreboard-card__stroke-indicator">${indicator}</span>` : ""}
          </span>
          ${cells}
          <span class="scoreboard-card__row-total">${formatValue(total)}</span>
        </div>
      `;
    };

    const buildInfoGroup = (holeRows, holeParTotal, holeHcpTotal) => {
      return `
        <div class="scoreboard-card__row-group">
          ${buildRow("Hole", holeRows.map((hole) => hole.hole_number), holeRows.length, "holes")}
          ${buildRow("Par", holeRows.map((hole) => hole.par), holeParTotal, "par")}
          ${buildRow("HCP", holeRows.map((hole) => hole.handicap), holeHcpTotal, "hcp")}
        </div>
      `;
    };

    const buildPlayerGroup = (player, rowsMarkup) => `
      <div class="scoreboard-card__row-group scoreboard-card__row-group--player">
        <span class="scoreboard-card__row-group-label">
          <span class="scoreboard-card__player-badge">
            <span></span>
            <span></span>
          </span>
          ${player.name}
        </span>
        ${rowsMarkup}
      </div>
    `;

    const buildMatchSection = (match) => {
      if (!match) {
        return "";
      }
      const holeRows = buildHoleRows(match);
      const holeParTotal = sumNumeric(holeRows.map((hole) => hole.par));
      const holeHcpTotal = sumNumeric(holeRows.map((hole) => hole.handicap));
      const infoGroup = buildInfoGroup(holeRows, holeParTotal, holeHcpTotal);
      const statusSymbol = computeMatchStatusSymbol(match);
      const statusCells = holeRows.map((_, idx) => (idx === 0 ? statusSymbol : ""));
      const playerGroups = [];
      (match.players || []).forEach((player, index) => {
        const playerScores = holeRows.map((hole) => hole.player_scores[index] || {});
        const grossValues = playerScores.map((score) => score.gross);
        const netValues = playerScores.map((score) => score.net);
        const grossRow = buildRow(
          "Gross",
          grossValues,
          sumNumeric(grossValues),
          "gross",
          getStrokeIndicatorSymbol(player, match.meta)
        );
        const netRow = buildRow("Net", netValues, sumNumeric(netValues), "net");
        playerGroups.push(buildPlayerGroup(player, `${grossRow}${netRow}`));
      });
      const divisionLabel = match.division ? `Division ${match.division}` : match.label || "Match";
      const matchupLabel =
        match.matchup ||
        (match.players && match.players.length >= 2
          ? `${match.players[0].name} vs ${match.players[1].name}`
          : match.label || `${match.player_a || "Player"} vs ${match.player_b || "Player"}`);
      const statusLabel =
        match.status_label || phaseLabels[match.status] || phaseLabels[match.phase] || "Status";
      return `
      <section class="scoreboard-card__match-block" data-key="${match.match_key}">
        <div class="scoreboard-card__match-block-header">
          <div>
            <span class="scoreboard-card__match-block-labels">${divisionLabel}</span>
            <strong class="scoreboard-card__matchup">${matchupLabel}</strong>
            ${match.match_key ? `<div class="scoreboard-card__meta"><span class="scoreboard-card__matchkey">Key: <strong>${match.match_key}</strong></span></div>` : ""}
          </div>
          <span class="scoreboard-card__status">${statusLabel}</span>
        </div>
        <div class="scoreboard-card__grid scoreboard-card__grid--match-block">
          ${infoGroup}
          ${playerGroups[0] || ""}
          ${buildRow("Match status", statusCells, statusSymbol, "status")}
          ${playerGroups[1] || ""}
          ${playerGroups.slice(2).join("")}
        </div>
      </section>
    `;
    };

    const buildGroupCard = (matches) => {
      if (!matches.length) {
        return `<article class="scoreboard-card scoreboard-card--empty">Match data unavailable</article>`;
      }
      const groupLabel = selectedGroupKey ? `Group ${selectedGroupKey}` : "Match summary";
      const groupKeys = matches
        .map((match) => match.match_key || "")
        .filter((key) => key)
        .join(" • ");
      const statusLabel =
        matches[0]?.status_label ||
        phaseLabels[matches[0]?.status] ||
        phaseLabels[matches[0]?.phase] ||
        "Preview";
      const sections = matches.map((match) => buildMatchSection(match)).join("");
      const matchupLabel =
        matches[0]?.matchup ||
        matches[0]?.label ||
        (matches[0]?.players && matches[0]?.players.length >= 2
          ? `${matches[0].players[0].name} vs ${matches[0].players[1].name}`
          : "");
      return `
      <article class="scoreboard-card scoreboard-card--group">
        <div class="scoreboard-card__header">
          <div>
            <span class="scoreboard-card__division">${groupLabel}</span>
            <strong class="scoreboard-card__matchup">${matchupLabel || "Group scoring preview"}</strong>
            ${groupKeys ? `<div class="scoreboard-card__meta"><span class="scoreboard-card__matchkey">Keys: <strong>${groupKeys}</strong></span></div>` : ""}
          </div>
          <span class="scoreboard-card__status">${statusLabel}</span>
        </div>
        <div class="scoreboard-card__group-body">
          ${sections}
        </div>
      </article>
    `;
    };

    const highlightScoreboards = (key) => {
      if (!matchTableEl) return;
      matchTableEl.querySelectorAll(".scoreboard-card__match-block").forEach((block) => {
        block.classList.toggle("scoreboard-card__match-block--active", block.dataset.key === key);
      });
    };

    const createFallbackMatchData = (entry) => {
      if (!entry) {
        return null;
      }
      const players = [
        { name: entry.player_a || "Player 1", role: "A" },
        { name: entry.player_b || "Player 2", role: "B" },
      ];
      const matchupLabel =
        entry.matchup || `${players[0].name} vs ${players[1]?.name || "TBD"}`;
      const holes = defaultHoleTemplate.map((hole) => ({
        hole_number: hole.hole_number,
        par: hole.par,
        handicap: hole.handicap,
        player_scores: players.map(() => ({ gross: null, net: null })),
      }));
    return {
        match_key: entry.match_key,
        label: entry.display || matchupLabel,
        division: entry.division,
        matchup: matchupLabel,
        summary: entry.summary,
        status: entry.status || "not_started",
        status_label:
          entry.status_label || phaseLabels[entry.status] || "Not started",
        phase: entry.phase || entry.status || "not_started",
        players,
        holes,
        course: entry.course || {},
        meta: entry.meta || {},
      };
    };

    const fetchGroupDefinitions = async () => {
      try {
        const response = await fetch("/api/match_groups");
        if (!response.ok) {
          throw new Error("Unable to load match groups.");
        }
        const data = await response.json();
        return Array.isArray(data.group_definitions) ? data.group_definitions : [];
      } catch (error) {
        console.warn("Match groups load failed:", error);
        return [];
      }
    };

    const handleGroupSelection = () => {
      renderGroupGrid();
      openModal();
    };

    const loadMatchData = async (matchKey) => {
      const matchMeta = sortedMatches.find((entry) => entry.match_key === matchKey);
      const fallback = matchMeta ? createFallbackMatchData(matchMeta) : null;
      if (!matchMeta || matchMeta.phase === "not_started") {
        return fallback;
      }
      try {
        const response = await fetch(`/api/match_scorecard?match_key=${matchKey}`);
        if (!response.ok) {
          throw new Error("Unable to load match data.");
        }
        const data = await response.json();
        return {
          ...fallback,
          ...data,
          division: matchMeta.division || data.division,
          status: matchMeta.status || data.status,
          status_label: matchMeta.status_label || data.status_label,
          matchup: data.matchup || fallback?.matchup,
        };
      } catch (error) {
        console.warn("Match data load failed:", error);
        return fallback;
      }
    };

    const displaySelectedMatches = async (matchKeys = []) => {
      if (!matchTableEl) return;
      const keys = matchKeys.length
        ? matchKeys
        : selectedMatchKeys.size
        ? [...selectedMatchKeys]
        : sortedMatches.slice(0, maxSelectableMatches).map((entry) => entry.match_key);
      if (!keys.length) {
        matchTableEl.innerHTML =
          '<div class="scoreboard-empty">Select up to two matches to preview.</div>';
        return;
      }
      const matchDataList = await Promise.all(keys.map((key) => loadMatchData(key)));
      const filteredMatches = matchDataList.filter((match) => !!match);
      matchTableEl.innerHTML = filteredMatches.length
        ? buildGroupCard(filteredMatches)
        : '<div class="scoreboard-empty">No match registered yet.</div>';
      highlightScoreboards(keys[0] || null);
    };

    const renderGroupGrid = () => {
      if (!matchModalGrid) return;
      matchModalGrid.innerHTML = "";
      const availableGroups = groupDefinitions.length ? groupDefinitions : sortedMatches.map((match) => ({
        group_key: match.match_key,
        label: match.label || match.display,
        match_keys: [match.match_key],
        status: match.status_label || phaseLabels[match.status] || phaseLabels[match.phase] || "Status",
        players: match.matchup || `${match.player_a || "Player"} vs ${match.player_b || "Player"}`,
      }));
      availableGroups.forEach((entry) => {
        const groupLabel = entry.label || entry.group_key || "Group";
        const matchKeys = (entry.match_keys || []).filter((key) => key);
        const item = document.createElement("button");
        item.className = "match-modal__item";
        item.type = "button";
        item.dataset.matchKeys = JSON.stringify(matchKeys);
        item.innerHTML = `
          <div>
            <strong>${groupLabel}</strong>
            <span class="match-modal__matchup">${entry.players || matchKeys.join(" • ")}</span>
          </div>
          <span class="match-modal__status">${entry.status}</span>
        `;
        item.addEventListener("click", () => {
          if (!matchKeys.length) {
            return;
          }
          selectedGroupKey = entry.group_key || "";
          selectedMatchKeys = new Set(matchKeys.slice(0, maxSelectableMatches));
          renderMatchGrid();
          displaySelectedMatches([...selectedMatchKeys]);
          closeModal();
        });
        if (selectedMatchKeys.size && matchKeys.some((key) => selectedMatchKeys.has(key))) {
          item.classList.add("match-modal__item--active");
        }
        matchModalGrid.appendChild(item);
      });
    };

    const renderMatchGrid = () => renderGroupGrid();

    const initializeSelections = () => {
      let keys = [];
      const preferredKey = requestedGroupKey || "";
      if (preferredKey && groupDefinitions.length) {
        const preferredDefinition = groupDefinitions.find((definition) => definition.group_key === preferredKey);
        if (preferredDefinition) {
          const matchedKeys = ensureGroupMatchKeys(preferredDefinition);
          if (matchedKeys.length) {
            keys = matchedKeys;
            selectedGroupKey = preferredDefinition.group_key || "";
          }
        }
      }
      if (!keys.length && groupDefinitions.length) {
        const fallbackDefinition = groupDefinitions[0];
        const matchedKeys = ensureGroupMatchKeys(fallbackDefinition);
        if (matchedKeys.length) {
          keys = matchedKeys;
          selectedGroupKey = fallbackDefinition.group_key || "";
        }
      }
      if (!keys.length) {
        keys = sortedMatches.slice(0, maxSelectableMatches).map((entry) => entry.match_key);
        selectedGroupKey = "";
      }
      selectedMatchKeys = new Set(keys.slice(0, maxSelectableMatches));
    };

    const openModal = () => modal?.classList.add("active");
    const closeModal = () => modal?.classList.remove("active");

    const sortAvailableMatches = (matches) => {
      return [...matches].sort((a, b) => {
        const phaseComparison = (phaseOrder[a.phase] ?? 3) - (phaseOrder[b.phase] ?? 3);
        if (phaseComparison !== 0) {
          return phaseComparison;
        }
        return (a.display || "").localeCompare(b.display || "");
      });
    };

    const loadMatches = async () => {
      let matches = [];
      try {
        const response = await fetch("/api/match_list");
        if (response.ok) {
          matches = await response.json();
        } else {
          throw new Error("Unable to load match list.");
        }
      } catch (error) {
        console.error("Match list load failed:", error);
      }
      const nextMatches = matches.length ? matches : seededMatches.length ? seededMatches : fallbackMatches;
      sortedMatches = sortAvailableMatches(nextMatches);
      groupDefinitions = await fetchGroupDefinitions();
      if (!matches.length) {
        sortedMatches.forEach((entry) => {
          entry.inlineMatchData = entry;
        });
      }
      if (!sortedMatches.length) {
        if (matchTableEl) {
          matchTableEl.innerHTML =
            '<div class="scoreboard-empty">No match registered yet.</div>';
        }
        return;
      }
      initializeSelections();
      renderMatchGrid();
      await displaySelectedMatches([...selectedMatchKeys]);
    };

    const populateHoleReferenceRows = () => {
      const reference = defaultHoleTemplate;
      const appendCells = (row, values) => {
        if (!row) return;
        values.forEach((value) => {
          const span = document.createElement("span");
          span.textContent = formatValue(value);
          row.appendChild(span);
        });
      };
      appendCells(holeRefHoleRow, reference.map((hole) => hole.hole_number));
      appendCells(holeRefParRow, reference.map((hole) => hole.par));
      appendCells(holeRefHcpRow, reference.map((hole) => hole.handicap));
    };

    matchModalSave?.addEventListener("click", async () => {
      await displaySelectedMatches([...selectedMatchKeys]);
      closeModal();
    });

    openModalBtn?.addEventListener("click", handleGroupSelection);
    modalClose?.addEventListener("click", closeModal);
    modal?.addEventListener("click", (event) => {
      if (event.target === modal) {
        closeModal();
      }
    });

    loadMatches();
    populateHoleReferenceRows();
  </script>


{% endblock %}
