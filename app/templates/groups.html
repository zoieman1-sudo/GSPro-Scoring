{% extends "base.html" %}

{% block content %}
  <section class="card">
    <div class="match-meta">
      <p class="eyebrow">Match Groups</p>
      <h1 class="match-title">Saved match groups</h1>
      {% if status %}
        <p class="muted-label">{{ status }}</p>
      {% endif %}
    </div>
    <form class="match-meta__controls" method="post" action="/admin/active_tournament">
      <input type="hidden" name="redirect" value="/groups" />
      <label>
        Tournament
        <select name="tournament_id" onchange="this.form.submit()">
          <option value="">Choose tournament</option>
          {% for tournament in tournaments %}
            <option value="{{ tournament.id }}" {% if tournament.id == active_tournament_id %}selected{% endif %}>
              {{ tournament.name }}
            </option>
          {% endfor %}
        </select>
      </label>
    </form>
    <article>
      <h3>Matches</h3>
      <table class="standings-table">
        <thead>
          <tr>
            <th>Match Key</th>
            <th>Division</th>
            <th>Players</th>
            <th>Course</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% if match_groups %}
            {% for group in match_groups %}
              {% set primary = group.matches[0] %}
              {% set secondary = group.matches[1] if group.matches|length > 1 else None %}
              {% set available_pairs = group.player_pairs or [] %}
              {% set match_one_label = available_pairs[0] if available_pairs else primary.player_a_name ~ " vs " ~ primary.player_b_name %}
              {% set match_two_label = available_pairs[1]
                if available_pairs|length > 1
                else (secondary.player_a_name ~ " vs " ~ secondary.player_b_name if secondary else "— vs —") %}
              <tr>
                <td>{{ group.group_key }}</td>
                <td>{{ primary.division }}</td>
                <td class="match-group-pairs">
                  <div>Match 1 · {{ match_one_label }}</div>
                  <div>
                    Match 2 · {{ match_two_label }}
                  </div>
                </td>
                <td>{% if primary.course_id %}{{ primary.course_id }}{% else %}—{% endif %}</td>
                <td>{{ primary.status }}</td>
                <td>
                  <div class="match-actions">
                    <a
                      href="/admin/match_setup?tournament_id={{ active_tournament_id }}&edit_match_id={{ primary.id }}"
                      class="pill-link pill-link--inline"
                    >
                      Edit
                    </a>
                    <a
                      href="/golf-ui/scoring.html?group_key={{ group.group_key }}"
                      target="_blank"
                      class="pill-link pill-link--inline"
                    >
                      Launch scoring
                    </a>
                    <form action="/admin/match_setup/delete" method="post" class="inline-form">
                      <input type="hidden" name="match_id" value="{{ primary.id }}" />
                      <input type="hidden" name="tournament_id" value="{{ active_tournament_id }}" />
                      <button type="submit" class="pill-link pill-link--danger pill-link--inline">
                        Delete
                      </button>
                    </form>
                  </div>
                </td>
              </tr>
            {% endfor %}
          {% else %}
            <tr><td colspan="6">No groups configured for the active tournament.</td></tr>
          {% endif %}
        </tbody>
      </table>
    </article>
    <article class="group-definitions-card" aria-label="Saved match groups">
      <div class="group-builder-card__header">
        <div>
          <p class="eyebrow">Match Groups</p>
          <h3>Saved scoring teams</h3>
          <p id="groupBuilderStatus" class="muted-label">Loading match groups…</p>
        </div>
      </div>
      <div class="group-definitions">
        <h4>Saved groups</h4>
        <ul id="savedGroupsList" class="group-definitions__list">
          <li class="placeholder">No groups have been recorded yet.</li>
        </ul>
      </div>
    </article>
    <article class="group-builder-card" aria-label="Match groups builder">
      <div class="group-builder-card__header">
        <div>
          <p class="eyebrow">Match Groups</p>
          <h3>Create scoring teams</h3>
        </div>
        <button id="saveGroupBtn" class="pill-link" type="button">Save group</button>
      </div>
      <div id="builderMatches" class="group-builder-card__matches"></div>
      <div class="group-builder-card__footer">
        <input id="groupLabelInput" type="text" name="group_label" placeholder="Group label (optional)" />
      </div>
    </article>
  </section>
  <style>
    .match-group-pairs div {
      line-height: 1.4;
      font-size: 0.85rem;
    }

    .group-definition__key {
      font-size: 0.78rem;
      color: #94a3b8;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      margin-bottom: 0.25rem;
    }
    .match-actions {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      flex-wrap: wrap;
    }
  </style>
{% endblock %}

{% block scripts %}
  <script>
    const currentTournamentId = {{ active_tournament_id if active_tournament_id else "null" }};
    (function () {
      const builderMatches = document.getElementById("builderMatches");
      const savedGroupsList = document.getElementById("savedGroupsList");
      const saveGroupBtn = document.getElementById("saveGroupBtn");
      const groupLabelInput = document.getElementById("groupLabelInput");
      const statusEl = document.getElementById("groupBuilderStatus");
      let activeMatches = [];
      let definitions = [];

      async function fetchMatchCourse(matchKey) {
        if (!matchKey) return null;
        const response = await fetch(`/api/match_scorecard?match_key=${encodeURIComponent(matchKey)}`);
        if (!response.ok) return null;
        const payload = await response.json().catch(() => null);
        return payload?.course || null;
      }

      function setStatus(message, muted = false) {
        if (!statusEl) return;
        statusEl.textContent = message;
        statusEl.classList.toggle("muted-label", muted);
      }

      function renderBuilderMatches() {
        if (!builderMatches) return;
        builderMatches.innerHTML = "";
        if (!activeMatches.length) {
          builderMatches.innerHTML = '<p class="muted-label">No active matches to group yet.</p>';
          return;
        }
        activeMatches.forEach((match) => {
          const label = document.createElement("label");
          label.className = "builder-match-item";
          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.value = match.match_key;
          const span = document.createElement("span");
          span.textContent = `${match.player_a || "Player A"} vs ${match.player_b || "Player B"}`;
          label.appendChild(checkbox);
          label.appendChild(span);
          builderMatches.appendChild(label);
        });
      }

      function renderSavedGroups(savedDefinitions) {
        if (!savedGroupsList) return;
        savedGroupsList.innerHTML = "";
        if (!savedDefinitions.length) {
          savedGroupsList.innerHTML = '<li class="placeholder">No groups have been recorded yet.</li>';
          return;
        }
        savedDefinitions.forEach((definition) => {
          const item = document.createElement("li");
          item.className = "group-definition";
          const label = document.createElement("div");
          label.className = "group-definition__label";
          label.textContent = definition.label || definition.group_key || "Group";
          const keyLabels = document.createElement("div");
          keyLabels.className = "group-definition__key";
          keyLabels.textContent = definition.group_key || "";
          const meta = document.createElement("div");
          meta.className = "group-definition__matches";
          const pairText =
            (definition.player_pairs && definition.player_pairs.length
              ? definition.player_pairs.join(" • ")
              : null) || (definition.match_keys || []).join(" • ");
          meta.textContent = pairText;
          const removeBtn = document.createElement("button");
          removeBtn.type = "button";
          removeBtn.className = "pill-link pill-link--inline";
          removeBtn.textContent = "Remove";
          removeBtn.addEventListener("click", () => handleRemoveGroup(definition.group_key));
          item.appendChild(label);
          item.appendChild(keyLabels);
          item.appendChild(meta);
          const launchKey = (definition.match_keys && definition.match_keys[0]) || definition.group_key || "";
          const launchLink = document.createElement("a");
          launchLink.className = "pill-link pill-link--inline";
          launchLink.textContent = "Launch scoring";
          launchLink.href = `/golf-ui/scoring.html?match_key=${encodeURIComponent(launchKey)}`;
          launchLink.target = "_blank";
          item.appendChild(launchLink);
          const editLink = document.createElement("a");
          editLink.className = "pill-link pill-link--inline";
          editLink.textContent = "Edit scorecard";
          editLink.href = `/golf-ui/scoring.html?match_key=${encodeURIComponent(launchKey)}&mode=edit`;
          editLink.target = "_blank";
          item.appendChild(editLink);
          item.appendChild(removeBtn);
          savedGroupsList.appendChild(item);
        });
      }

      function gatherSelectedMatchKeys() {
        if (!builderMatches) return [];
        const inputs = builderMatches.querySelectorAll('input[type="checkbox"]:checked');
        return Array.from(inputs).map((input) => input.value);
      }

      async function persistDefinitions(items) {
        const response = await fetch("/api/match_groups", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ groups: items }),
        });
        if (!response.ok) {
          throw new Error("Unable to save the group definitions.");
        }
        const payload = await response.json().catch(() => null);
        definitions = Array.isArray(payload?.group_definitions) ? payload.group_definitions : items;
      }

      async function handleSaveGroup() {
        const selectedMatches = gatherSelectedMatchKeys();
        if (!selectedMatches.length) {
          setStatus("Select at least one match to group.", true);
          return;
        }
        const label = groupLabelInput?.value?.trim() || "";
        const baseKey = label || `group-${selectedMatches.join("-")}`;
        const courseInfo = await fetchMatchCourse(selectedMatches[0]);
        const payload = [
          ...definitions,
          {
            group_key: baseKey,
            label,
            match_keys: selectedMatches,
            course: courseInfo || {},
            tournament_id: currentTournamentId,
          },
        ];
        try {
          await persistDefinitions(payload);
          setStatus(`Group ${label || baseKey} saved.`);
          groupLabelInput && (groupLabelInput.value = "");
          builderMatches?.querySelectorAll('input[type="checkbox"]').forEach((input) => {
            input.checked = false;
          });
          await loadGroups();
        } catch (error) {
          setStatus(error?.message || "Unable to save the group.", true);
        }
      }

      async function handleRemoveGroup(groupKey) {
        const remaining = definitions.filter((entry) => entry.group_key !== groupKey);
        try {
          await persistDefinitions(remaining);
          setStatus("Group removed.");
          await loadGroups();
        } catch (error) {
          setStatus(error?.message || "Unable to remove the group.", true);
        }
      }

      async function loadGroups() {
        try {
          const response = await fetch("/api/match_groups");
          if (!response.ok) {
            throw new Error("Failed to load match groups.");
          }
          const payload = await response.json();
          activeMatches = Array.isArray(payload.active_matches) ? payload.active_matches : [];
          definitions = Array.isArray(payload.group_definitions) ? payload.group_definitions : [];
          renderBuilderMatches();
          renderSavedGroups(definitions);
          setStatus(
            definitions.length ? `${definitions.length} group(s) saved.` : "No groups saved yet.",
            !definitions.length
          );
        } catch (error) {
          setStatus(error?.message || "Unable to load match groups.", true);
        }
      }

      saveGroupBtn?.addEventListener("click", (event) => {
        event.preventDefault();
        handleSaveGroup();
      });
      loadGroups();
    })();
  </script>
  <script>
    const GROUPS_TOURNAMENT_STORAGE = "gspro.groups.tournament";
    document.addEventListener("DOMContentLoaded", () => {
      const form = document.querySelector("form.match-meta__controls");
      const select = form?.querySelector('select[name="tournament_id"]');
      const redirectInput = form?.querySelector('input[name="redirect"]');
      if (select && redirectInput) {
        select.addEventListener("change", () => {
          redirectInput.value = `/groups?tournament_id=${select.value}`;
          if (select.value) {
            localStorage.setItem(GROUPS_TOURNAMENT_STORAGE, select.value);
          } else {
            localStorage.removeItem(GROUPS_TOURNAMENT_STORAGE);
          }
        });
      }
      const params = new URLSearchParams(window.location.search);
      const currentParam = params.get("tournament_id");
      const storedId = localStorage.getItem(GROUPS_TOURNAMENT_STORAGE);
      if (currentParam) {
        localStorage.setItem(GROUPS_TOURNAMENT_STORAGE, currentParam);
      } else if (storedId && storedId !== (select?.value || "")) {
        params.set("tournament_id", storedId);
        window.location.search = params.toString();
      }
    });
  </script>
{% endblock %}
