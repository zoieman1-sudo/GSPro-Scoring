{% extends "kiosk_base.html" %}

{% block content %}
  <style>
    body.kiosk-base {
      background: radial-gradient(circle at top, rgba(255, 255, 255, 0.9), transparent 55%),
        linear-gradient(180deg, #f0f2ff 0%, #e1e6f5 65%, #b1b7d9 100%);
    }
    .kiosk-leaderboard-shell {
      width: 100%;
      padding: 32px;
      border-radius: 36px;
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.95), rgba(243, 247, 255, 0.8));
      box-shadow: 0 20px 60px rgba(16, 23, 44, 0.35);
      display: flex;
      flex-direction: column;
      gap: 28px;
      border: 1px solid rgba(255, 255, 255, 0.6);
      backdrop-filter: blur(16px);
    }
    .kiosk-leaderboard-header {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .kiosk-leaderboard-header h1 {
      margin: 0;
      font-size: clamp(2.2rem, 3vw, 3rem);
      letter-spacing: 0.3em;
      text-transform: uppercase;
      color: #111;
    }
    .kiosk-leaderboard-meta {
      font-size: 1rem;
      letter-spacing: 0.35em;
      color: rgba(18, 22, 48, 0.6);
    }
    .kiosk-leaderboard-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 24px;
    }
    .kiosk-leaderboard-card {
      padding: 28px 32px;
      min-height: 220px;
      border-radius: 32px;
      border: 1px solid rgba(18, 22, 48, 0.12);
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.9), rgba(233, 238, 255, 0.95));
      box-shadow: -10px 15px 40px rgba(15, 22, 42, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.8);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .kiosk-leaderboard-card strong {
      font-size: 3rem;
      color: #0f1326;
      letter-spacing: 0.25em;
    }
    .kiosk-leaderboard-card span {
      color: rgba(18, 22, 48, 0.55);
      font-size: 0.75rem;
      letter-spacing: 0.3em;
    }
    .kiosk-leaderboard-card ul {
      margin: 0;
      padding: 0;
      list-style: none;
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 1rem;
    }
    .kiosk-leaderboard-card li {
      color: rgba(18, 22, 48, 0.7);
    }
    .kiosk-leaderboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
      gap: 20px;
    }
    .kiosk-division-card {
      border-radius: 30px;
      background: rgba(247, 249, 255, 0.95);
      border: 1px solid rgba(18, 22, 48, 0.15);
      padding: 24px;
      box-shadow: inset 0 0 40px rgba(255, 255, 255, 0.8), 0 18px 30px rgba(15, 23, 42, 0.08);
      min-height: 260px;
    }
    .kiosk-division-card h2 {
      margin: 0 0 12px;
      font-size: 1.2rem;
      letter-spacing: 0.3em;
      color: rgba(18, 22, 48, 0.6);
    }
    .kiosk-division-card table {
      width: 100%;
      border-collapse: collapse;
      font-size: 1rem;
      letter-spacing: 0.2em;
    }
    .kiosk-division-card th,
    .kiosk-division-card td {
      padding: 6px 8px;
      text-align: left;
      color: #0f172a;
    }
    .kiosk-division-card tr:nth-child(even) {
      background: rgba(18, 22, 48, 0.05);
    }
    @media (max-width: 900px) {
      .kiosk-leaderboard-shell {
        padding: 20px;
      }
    }
  </style>

  <section class="kiosk-leaderboard-shell">
    <header class="kiosk-leaderboard-header">
      <p class="kiosk-leaderboard-meta">
        Standings optimized for kiosk viewing · auto-refresh every 10 seconds
      </p>
      <h1>Division Leaderboard</h1>
    </header>

    <div class="kiosk-leaderboard-cards">
      <article class="kiosk-leaderboard-card">
        <span>Live matches</span>
        <strong id="live-count">{{ active_match_count }}</strong>
        <ul>
          {% for match in active_matches[:3] %}
            <li>{{ match.match_key }} · {{ match.status_label }}</li>
          {% else %}
            <li>No live matches</li>
          {% endfor %}
        </ul>
      </article>
      <article class="kiosk-leaderboard-card">
        <span>Finalized</span>
        <strong>{{ finalized_match_count }}</strong>
        <ul>
          {% for match in finalized_matches[:3] %}
            <li>{{ match.match_key }} · {{ match.status_label }}</li>
          {% else %}
            <li>Nothing finalized yet</li>
          {% endfor %}
        </ul>
      </article>
    </div>

    <div id="kiosk-division-refresh" class="kiosk-leaderboard-grid">
      {% for division in divisions %}
        <article class="kiosk-division-card">
          <h2>Division {{ division.division }}</h2>
          <table>
            <thead>
              <tr>
                <th>Player</th>
                <th>Pts</th>
                <th>W-L-T</th>
              </tr>
            </thead>
            <tbody>
              {% for player in division.players %}
                <tr>
                  <td>{{ player.name }}</td>
                  <td>{{ player.points_for }}</td>
                  <td>{{ player.wins }}-{{ player.losses }}-{{ player.ties }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </article>
      {% endfor %}
    </div>
  </section>

{% block scripts %}
  <script>
    (function () {
      const refreshSelector = "#kiosk-division-refresh";
      const container = document.querySelector(refreshSelector);
      const refreshInterval = 10000;
      if (!container) {
        return;
      }

      const schedule = () => {
        window.setTimeout(refreshStandings, refreshInterval);
      };

      async function refreshStandings() {
        try {
          const response = await fetch(window.location.href, { cache: "no-store" });
          if (!response.ok) throw new Error("Unable to refresh leaderboard");
          const html = await response.text();
          const parser = new DOMParser();
          const doc = parser.parseFromString(html, "text/html");
          const updated = doc.querySelector(refreshSelector);
          if (updated) {
            container.innerHTML = updated.innerHTML;
          }
        } catch (error) {
          console.warn("leaderboard refresh failed", error);
        } finally {
          schedule();
        }
      }

      schedule();
    })();
  </script>
{% endblock %}
{% endblock %}
