{% extends "base.html" %}
{% block content %}
    {% set front_holes = scorecard.holes[:9] %}
    {% set back_holes = scorecard.holes[9:] %}
    {% macro team_display(primary, partner) -%}
      {{ primary }}{% if partner %}&nbsp;&amp;&nbsp;{{ partner }}{% endif %}
    {%- endmacro %}
    {% macro format_score(value) -%}
      {%- if value is none -%}
        —  
      {%- elif value % 1 -%}
        {{ value|round(1) }}
      {%- else -%}
        {{ value|int }}
      {%- endif -%}
    {%- endmacro %}

    {% macro score_badge(value, par) -%}
      {%- set cls = "score-value" -%}
      {%- set display = format_score(value) -%}
      {%- if value is not none and par is not none -%}
        {%- set diff = value - par -%}
        {%- if diff < 0 -%}
          {%- if diff <= -2 -%}
            {%- set cls = cls + " double-circle" -%}
          {%- else -%}
            {%- set cls = cls + " circle" -%}
          {%- endif -%}
        {%- elif diff == 0 -%}
          {%- set cls = cls + " green" -%}
        {%- elif diff == 1 -%}
          {%- set cls = cls + " box" -%}
        {%- elif diff >= 2 -%}
          {%- set cls = cls + " double-box" -%}
        {%- endif -%}
      {%- endif -%}
      <span class="{{ cls }}">{{ display }}</span>
    {%- endmacro %}

    <style>
      .score-value {
        display: inline-block;
        padding: 2px 6px;
        border-radius: 999px;
        font-weight: 600;
        font-size: 0.95rem;
      }
      .score-value.circle {
        border: 1px solid #ff5b5b;
        color: #ff5b5b;
      }
      .score-value.double-circle {
        border: 2px solid #ff5b5b;
        padding: 2px 8px;
        color: #ff5b5b;
      }
      .score-value.green {
        background: rgba(64, 255, 168, 0.15);
        color: #40ff96;
      }
      .score-value.box {
        border: 1px solid rgba(255, 169, 89, 0.8);
        color: #ffd38a;
      }
      .score-value.double-box {
        border: 2px solid rgba(255, 169, 89, 0.8);
        padding: 2px 8px;
        color: #ffd38a;
      }
      .match-status-control {
        display: none;
      }
    </style>

    {% macro sum_attr(holes, attr) -%}
      {%- set total = 0 -%}
      {%- for hole in holes -%}
        {%- set value = hole[attr] if hole[attr] is not none else 0 -%}
        {%- set total = total + value -%}
      {%- endfor -%}
      {{ total }}
    {%- endmacro %}

    <section class="card detail-card scorecard-panel">
      <div class="scorecard-layout">
        <div class="scorecard-info">
          <div class="scorecard-header-row scorecard-data">
            <div class="scorecard-data__header">
              <h1>Scorecard</h1>
              <p class="scorecard-data__summary">
                Match {{ scorecard.match.match_key }} · Division {{ scorecard.match.division }}
                <span>Status: {{ scorecard.match.status_label }}</span>
              </p>
            </div>
            <div class="scorecard-data__selector">
              <form class="scorecard-selector" id="match-select-form" method="get" action="/scorecard">
                <label>
                  <span>Select match</span>
                  <select id="match-select" name="match_key" onchange="this.form.submit()">
                    {% for match_option in matches %}
                      {% set team_a = team_display(match_option.player_a, match_option.player_c) %}
                      {% set team_b = team_display(match_option.player_b, match_option.player_d) %}
                      <option value="{{ match_option.match_id }}" {% if match_option.match_id == active_match_key %}selected{% endif %}>
                        Division {{ match_option.division }}: {{ team_a }} vs {{ team_b }}
                      </option>
                    {% endfor %}
                  </select>
                </label>
              </form>
              <span class="scorecard-select-status">
                {{ scorecard.match.holes_recorded }} / {{ scorecard.match.total_holes }} holes recorded
              </span>
            </div>
          </div>

          <div class="scorecard-tabs" role="tablist">
            <button type="button" class="tab-btn active" data-tab="front">Holes 1-9</button>
            <button type="button" class="tab-btn" data-tab="back">Holes 10-18</button>
          </div>

<div class="scorecard-summary-grid">
            <div class="scorecard-summary-block">
              <span class="muted-label">Stroke allocation</span>
              <p class="match-subtle" id="stroke-allocation">
                {% if scorecard.meta.stroke_owner %}
                  {{ scorecard.match.player_a_name if scorecard.meta.stroke_owner == 'A' else scorecard.match.player_b_name }}
                  receives
                  {{ scorecard.meta.stroke_count if scorecard.meta.stroke_count % 1 else scorecard.meta.stroke_count|int }} stroke{{ 's' if scorecard.meta.stroke_count != 1 else '' }}
                  {% if scorecard.meta.is_nine_hole %}(9-hole allowance applied){% endif %}
                {% else %}
                  No strokes allocated for this matchup.
                {% endif %}
              </p>
            </div>
          </div>

          <div class="scorecard-actions">
            {% if scorecard.match.id %}
              <a class="pill-link" href="/matches/{{ scorecard.match.id }}">Edit hole inputs</a>
            {% else %}
              <a class="pill-link" href="/golf-ui/scoring.html">Enter scores</a>
            {% endif %}
          </div>
        </div>

        <div class="scorecard-column scorecard-holes-column">
        <div class="scorecard-pane scorecard-pane--front active" data-section="front">
            <h3 class="scorecard-column-title">Holes 1-9</h3>
            <section class="match-scorecard-table" aria-label="Front nine scorecard">
              <div class="match-scorecard-row match-scorecard-head">
                <span class="col-label">Hole</span>
                <span class="col-label">Par</span>
                <span class="col-label">HCP</span>
              <span class="col-label col-label--stacked">
                <abbr title="{{ scorecard.match.player_a_name }}">A</abbr>
                <abbr title="Gross">Gross</abbr>
              </span>
              <span class="col-label col-label--stacked">
                <abbr title="{{ scorecard.match.player_b_name }}">B</abbr>
                <abbr title="Gross">Gross</abbr>
              </span>
              <span class="col-label col-label--stacked">
                <abbr title="{{ scorecard.match.player_a_name }}">A</abbr>
                <abbr title="Net">Net</abbr>
              </span>
              <span class="col-label col-label--stacked">
                <abbr title="{{ scorecard.match.player_b_name }}">B</abbr>
                <abbr title="Net">Net</abbr>
              </span>
            <span class="col-label">Pts A</span>
            <span class="col-label">Pts B</span>
              </div>
              <div class="match-scorecard-body" id="front-rows">
              {% for hole in front_holes %}
                <div class="match-scorecard-row" data-hole="{{ hole.hole_number }}">
                  <span class="hole-number">{{ hole.hole_number }}</span>
                  <span class="hole-par">{{ hole.par }}</span>
                  <span class="hole-hcp">{{ hole.handicap }}</span>
                  <span class="gross-a">{{ score_badge(hole.gross_a, hole.par)|safe }}</span>
                  <span class="gross-b">{{ score_badge(hole.gross_b, hole.par)|safe }}</span>
                  <span class="net-a">{{ score_badge(hole.net_a, hole.par)|safe }}</span>
                  <span class="net-b">{{ score_badge(hole.net_b, hole.par)|safe }}</span>
                <span class="points-a">{{ format_score(hole.points_a) }}</span>
                <span class="points-b">{{ format_score(hole.points_b) }}</span>
                </div>
              {% endfor %}
              <div class="match-scorecard-row match-scorecard-totals">
                <span></span>
                <span class="hole-par">{{ sum_attr(front_holes, 'par') }}</span>
                <span></span>
                <span class="gross-a">{{ sum_attr(front_holes, 'gross_a') }}</span>
                <span class="gross-b">{{ sum_attr(front_holes, 'gross_b') }}</span>
                <span class="net-a">{{ sum_attr(front_holes, 'net_a') }}</span>
                <span class="net-b">{{ sum_attr(front_holes, 'net_b') }}</span>
                <span class="points-a">{{ sum_attr(front_holes, 'points_a') }}</span>
                <span class="points-b">{{ sum_attr(front_holes, 'points_b') }}</span>
              </div>
              </div>
            </section>
          </div>
          <div class="scorecard-pane scorecard-pane--back" data-section="back">
            <h3 class="scorecard-column-title">Holes 10-18</h3>
            <section class="match-scorecard-table" aria-label="Back nine scorecard">
          <div class="match-scorecard-row match-scorecard-head">
            <span>Hole</span>
            <span>Par</span>
            <span>HCP</span>
            <span class="col-label col-label--stacked">
              <abbr title="{{ scorecard.match.player_a_name }}">A</abbr>
              <abbr title="Gross">Gross</abbr>
            </span>
            <span class="col-label col-label--stacked">
              <abbr title="{{ scorecard.match.player_b_name }}">B</abbr>
              <abbr title="Gross">Gross</abbr>
            </span>
            <span class="col-label col-label--stacked">
              <abbr title="{{ scorecard.match.player_a_name }}">A</abbr>
              <abbr title="Net">Net</abbr>
            </span>
            <span class="col-label col-label--stacked">
              <abbr title="{{ scorecard.match.player_b_name }}">B</abbr>
              <abbr title="Net">Net</abbr>
            </span>
            <span>Pts A</span>
            <span>Pts B</span>
          </div>
              <div class="match-scorecard-body" id="back-rows">
              {% for hole in back_holes %}
                <div class="match-scorecard-row" data-hole="{{ hole.hole_number }}">
                  <span class="hole-number">{{ hole.hole_number }}</span>
                  <span class="hole-par">{{ hole.par }}</span>
                  <span class="hole-hcp">{{ hole.handicap }}</span>
                  <span class="gross-a">{{ score_badge(hole.gross_a, hole.par)|safe }}</span>
                  <span class="gross-b">{{ score_badge(hole.gross_b, hole.par)|safe }}</span>
                  <span class="net-a">{{ score_badge(hole.net_a, hole.par)|safe }}</span>
                  <span class="net-b">{{ score_badge(hole.net_b, hole.par)|safe }}</span>
                  <span class="points-a">{{ format_score(hole.points_a) }}</span>
                  <span class="points-b">{{ format_score(hole.points_b) }}</span>
                </div>
              {% endfor %}
              <div class="match-scorecard-row match-scorecard-totals">
                <span></span>
                <span class="hole-par">{{ sum_attr(back_holes, 'par') }}</span>
                <span></span>
                <span class="gross-a">{{ sum_attr(back_holes, 'gross_a') }}</span>
                <span class="gross-b">{{ sum_attr(back_holes, 'gross_b') }}</span>
                <span class="net-a">{{ sum_attr(back_holes, 'net_a') }}</span>
                <span class="net-b">{{ sum_attr(back_holes, 'net_b') }}</span>
                <span class="points-a">{{ sum_attr(back_holes, 'points_a') }}</span>
                <span class="points-b">{{ sum_attr(back_holes, 'points_b') }}</span>
              </div>
              </div>
            </section>
          </div>
            <div class="scorecard-points-row scorecard-points-row--centered">
              <div class="scorecard-points-chip">
                <span id="points-player-a">{{ scorecard.match.player_a_name }}</span>
                <strong id="points-a">
                  {% set chip_a = scorecard.point_chip_a %}
                  {% if chip_a % 1 %}
                    {{ chip_a|round(1) }}
                  {% else %}
                    {{ chip_a|int }}
                  {% endif %}
                </strong>
              </div>
              <div class="scorecard-points-chip">
                <span id="points-player-b">{{ scorecard.match.player_b_name }}</span>
                <strong id="points-b">
                  {% set chip_b = scorecard.point_chip_b %}
                  {% if chip_b % 1 %}
                    {{ chip_b|round(1) }}
                  {% else %}
                    {{ chip_b|int }}
                  {% endif %}
                </strong>
              </div>
            </div>
        </div>

      <script>
        document.addEventListener("DOMContentLoaded", () => {
          const tabs = document.querySelectorAll(".tab-btn");
          const panes = document.querySelectorAll(".scorecard-pane[data-section]");
          const strokeText = document.getElementById("stroke-allocation");
          const pointsAEl = document.getElementById("points-a");
          const pointsBEl = document.getElementById("points-b");
          const pointsLabelA = document.getElementById("points-player-a");
          const pointsLabelB = document.getElementById("points-player-b");
          const frontRows = document.getElementById("front-rows");
          const backRows = document.getElementById("back-rows");
          const matchSelect = document.getElementById("match-select");
          const selectorForm = document.getElementById("scorecard-selector-form");
          const matchStatusControl = document.getElementById("match-status-control");
          const matchDivisionEl = document.getElementById("match-division");
          const playerANameEl = document.getElementById("match-player-a");
          const playerBNameEl = document.getElementById("match-player-b");
          const playerAHcpEl = document.getElementById("match-hcp-a");
          const playerBHcpEl = document.getElementById("match-hcp-b");
          const courseMetaEl = document.getElementById("course-meta");
          const statusPill = document.getElementById("match-status-pill");
          const statusDetail = document.getElementById("match-status-detail");
          const activeMatchesData = {{ active_matches | tojson }};
          let activeMatchKey = {{ active_match_key | tojson }};

          tabs.forEach((tab) => {
            tab.addEventListener("click", () => {
              const target = tab.dataset.tab;
              tabs.forEach((btn) => btn.classList.toggle("active", btn === tab));
              panes.forEach((pane) => {
                const isTarget = pane.dataset.section === target;
                pane.classList.toggle("active", isTarget);
              });
            });
          });

          const formatNumber = (value) => {
            if (value === null || value === undefined || value === "") {
              return "—";
            }
            const num = Number(value);
            if (Number.isFinite(num)) {
              return Number.isInteger(num) ? `${num}` : num.toFixed(1);
            }
            return value;
          };

          const sumColumn = (rows, key) =>
            (rows || []).reduce((total, hole) => {
              const value = Number(hole?.[key]);
              return total + (Number.isFinite(value) ? value : 0);
            }, 0);

          const scoreBadge = (value, par) => {
            const num = Number(value);
            const diff = Number.isFinite(num) && Number.isFinite(Number(par)) ? num - Number(par) : null;
            let modifier = "";
            if (diff !== null && Number.isFinite(diff) && Number.isFinite(num) && num >= 1) {
              if (diff < 0) {
                modifier = diff <= -2 ? "double-circle" : "circle";
              } else if (diff === 0) {
                modifier = "green";
              } else if (diff === 1) {
                modifier = "box";
              } else if (diff >= 2) {
                modifier = "double-box";
              }
            }
            const display = formatNumber(value);
            return `<span class="score-value ${modifier}">${display}</span>`;
          };

          const formatCourseMeta = (course) => {
            if (!course) {
              return "";
            }
            const parts = [];
            if (course.club_name) {
              parts.push(course.club_name);
            }
            if (course.course_name) {
              parts.push(course.course_name);
            }
            const details = [];
            if (course.tee_name) {
              details.push(`Tee: ${course.tee_name}`);
            }
            if (course.total_yards) {
              details.push(`${course.total_yards} yds`);
            }
            if (course.course_rating) {
              details.push(`CR ${course.course_rating} / SR ${course.slope_rating || "—"}`);
            }
            return parts.join(" — ") + (details.length ? ` | ${details.join(" | ")}` : "");
          };

          const buildHoleRows = (holes) =>
            (holes || [])
              .map(
                (hole) => `
                  <div class="match-scorecard-row" data-hole="${hole.hole_number}">
                    <span class="hole-number">${hole.hole_number ?? "—"}</span>
                    <span class="hole-par">${hole.par ?? "—"}</span>
                    <span class="hole-hcp">${hole.handicap ?? "—"}</span>
                    <span class="gross-a">${scoreBadge(hole.gross_a, hole.par)}</span>
                    <span class="gross-b">${scoreBadge(hole.gross_b, hole.par)}</span>
                    <span class="net-a">${scoreBadge(hole.net_a, hole.par)}</span>
                    <span class="net-b">${scoreBadge(hole.net_b, hole.par)}</span>
                    <span class="points-a">${formatNumber(hole.points_a)}</span>
                    <span class="points-b">${formatNumber(hole.points_b)}</span>
                  </div>
                `
              )
              .join("");

          const buildTotalsRowHTML = (holes) => `
                <div class="match-scorecard-row match-scorecard-totals">
                  <span></span>
                  <span class="hole-par">${formatNumber(sumColumn(holes, "par"))}</span>
                  <span></span>
                  <span class="gross-a">${formatNumber(sumColumn(holes, "gross_a"))}</span>
                  <span class="gross-b">${formatNumber(sumColumn(holes, "gross_b"))}</span>
                  <span class="net-a">${formatNumber(sumColumn(holes, "net_a"))}</span>
                  <span class="net-b">${formatNumber(sumColumn(holes, "net_b"))}</span>
                  <span class="points-a">${formatNumber(sumColumn(holes, "points_a"))}</span>
                  <span class="points-b">${formatNumber(sumColumn(holes, "points_b"))}</span>
              </div>
            `;

          const buildHoleSectionHTML = (holes) => buildHoleRows(holes) + buildTotalsRowHTML(holes);

          const renderHoleSection = (container, holes) => {
            if (!container) {
              return;
            }
            container.innerHTML = buildHoleSectionHTML(holes);
          };

          const composeStrokeMessage = (meta, match) => {
            if (!meta?.stroke_owner) {
              return "No strokes allocated for this matchup.";
            }
            const owner = meta.stroke_owner === "A" ? match.player_a_name : match.player_b_name;
            const count = Number.isInteger(meta.stroke_count) ? meta.stroke_count : meta.stroke_count?.toFixed(1);
            const suffix = meta.stroke_count === 1 ? "" : "s";
            const nineHole = meta.is_nine_hole ? " (9-hole allowance applied)" : "";
            return `${owner} receives ${count} stroke${suffix}${nineHole}`;
          };

          const updateHeader = (payload) => {
            const match = payload.match || {};
            if (matchDivisionEl) {
              matchDivisionEl.textContent = match.division ? `Division ${match.division}` : "Match Scorecard";
            }
            if (playerANameEl) {
              playerANameEl.textContent = match.player_a_name || "Player A";
            }
            if (playerBNameEl) {
              playerBNameEl.textContent = match.player_b_name || "Player B";
            }
            if (playerAHcpEl) {
              playerAHcpEl.textContent = `hcp ${payload.player_a_handicap ?? 0}`;
            }
            if (playerBHcpEl) {
              playerBHcpEl.textContent = `hcp ${payload.player_b_handicap ?? 0}`;
            }
            if (courseMetaEl) {
              courseMetaEl.textContent = formatCourseMeta(payload.course);
            }
            const status = match.status || "not_started";
            if (statusPill) {
              statusPill.textContent = match.status_label || "Not started";
              statusPill.className = `status-pill status-pill--${status}`;
            }
            if (statusDetail) {
              statusDetail.textContent = `${match.holes_recorded || 0} / ${match.total_holes || 18} holes recorded`;
            }
            if (pointsLabelA) {
              pointsLabelA.textContent = match.player_a_name || "Player A";
            }
            if (pointsLabelB) {
              pointsLabelB.textContent = match.player_b_name || "Player B";
            }
          };

          const renderActiveMatchControls = (selectedKey) => {
            if (!matchStatusControl || !activeMatchesData.length) {
              return;
            }
            matchStatusControl.innerHTML = "";
            activeMatchesData.forEach((item) => {
              const button = document.createElement("button");
              button.type = "button";
              button.className = "match-status-btn";
              if (item.match_key === selectedKey) {
                button.classList.add("active");
              }
              button.dataset.matchKey = item.match_key;
              button.innerHTML = `
                <span class="match-status-btn__title">${item.display}</span>
                <span class="match-status-btn__meta">${item.status_label} · ${item.holes} holes recorded</span>
              `;
              button.addEventListener("click", () => {
                setActiveMatchKey(item.match_key);
              });
              matchStatusControl.appendChild(button);
            });
          };

          const setActiveMatchKey = (matchKey) => {
            if (!matchKey) {
              return;
            }
            activeMatchKey = matchKey;
            if (matchSelect) {
              matchSelect.value = matchKey;
            }
            renderActiveMatchControls(matchKey);
            refreshScorecard();
          };

          if (selectorForm) {
            selectorForm.addEventListener("submit", (event) => {
              event.preventDefault();
              if (matchSelect) {
                setActiveMatchKey(matchSelect.value);
              }
            });
          }
          const refreshScorecard = async () => {
            if (!activeMatchKey) {
              return;
            }
            try {
              const response = await fetch(`/api/scorecard/${activeMatchKey}`);
              if (!response.ok) {
                return;
              }
              const payload = await response.json();
              if (frontRows) {
                renderHoleSection(frontRows, payload.holes?.slice(0, 9) || []);
              }
              if (backRows) {
                renderHoleSection(backRows, payload.holes?.slice(9) || []);
              }
              if (strokeText) {
                strokeText.textContent = composeStrokeMessage(payload.meta || {}, payload.match || {});
              }
              if (pointsAEl) {
                pointsAEl.textContent = formatNumber(payload.point_chip_a);
              }
              if (pointsBEl) {
                pointsBEl.textContent = formatNumber(payload.point_chip_b);
              }
              updateHeader(payload);
            } catch (error) {
              console.error("Unable to refresh scorecard:", error);
            }
          };

          renderActiveMatchControls(activeMatchKey);
          refreshScorecard();
          setInterval(refreshScorecard, 8000);
        });
      </script>
    </section>
{% endblock %}
