<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>Mobile Scoring</title>
    <style>
      :root {
        font-family: "Inter", system-ui, -apple-system, sans-serif;
        color: #f5f7ff;
      }
      body {
        margin: 0;
        font-size: 16px;
        background: #050811;
      }
      .mobile-shell {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        gap: 12px;
        padding: 16px;
        background: linear-gradient(180deg, #040612 0%, #070b1c 60%, #05060f 100%);
      }
      .header {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }
      .page-title {
        margin: 0;
        font-size: 1.3rem;
        letter-spacing: 0.05em;
      }
      .page-subtitle {
        margin: 0;
        font-size: 0.95rem;
        color: rgba(255, 255, 255, 0.7);
      }
      .hole-bar {
        display: grid;
        grid-template-columns: auto 1fr auto;
        align-items: center;
        background: #10223a;
        border-radius: 14px;
        padding: 10px 14px;
        gap: 8px;
        box-shadow: inset 0 0 30px rgba(6, 13, 33, 0.6);
      }
      .hole-nav {
        border: 1px solid rgba(255, 255, 255, 0.2);
        background: transparent;
        color: #f5f7ff;
        border-radius: 12px;
        padding: 6px 10px;
        font-weight: 700;
        cursor: pointer;
      }
      .hole-info {
        text-align: center;
      }
      .hole-number {
        display: block;
        font-size: 1.1rem;
        font-weight: 700;
      }
      .hole-meta {
        display: block;
        font-size: 0.9rem;
        color: rgba(255, 255, 255, 0.7);
      }
      .status-row {
        background: #0d1323;
        border-radius: 14px;
        padding: 12px 14px;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .status-label {
        font-size: 0.85rem;
        letter-spacing: 0.2em;
        text-transform: uppercase;
        color: rgba(255, 255, 255, 0.7);
      }
      .status-pills {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }
      .pill {
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 12px;
        padding: 6px 10px;
        min-width: 130px;
      }
      .pill strong {
        display: block;
        font-size: 0.95rem;
      }
      .pill span {
        display: block;
        font-size: 0.75rem;
        color: rgba(255, 255, 255, 0.6);
      }
      .match-panels {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      .match-panel {
        background: #0b1426;
        border-radius: 18px;
        padding: 16px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      .match-panel + .match-panel {
        border-top: 2px solid rgba(255, 255, 255, 0.08);
      }
      .panel-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 12px;
      }
      .panel-division {
        margin: 0;
        font-size: 0.8rem;
        letter-spacing: 0.3em;
        text-transform: uppercase;
        color: rgba(255, 255, 255, 0.5);
      }
      .panel-match-name {
        margin: 4px 0 0;
        font-size: 1.05rem;
        font-weight: 700;
      }
      .panel-status {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.2em;
        color: rgba(255, 255, 255, 0.6);
      }
      .player-stack {
        display: flex;
        align-items: center;
        gap: 6px;
        margin: 12px 0;
      }
      .player-stack strong {
        display: block;
        font-size: 1rem;
      }
      .player-hcp {
        font-size: 0.75rem;
        color: rgba(255, 255, 255, 0.6);
      }
      .vs-label {
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.3em;
        color: rgba(255, 255, 255, 0.5);
      }
      .player-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 0;
      }
      .player-row + .player-row {
        border-top: 1px solid rgba(255, 255, 255, 0.05);
      }
      .player-info {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }
      .player-name {
        margin: 0;
        font-size: 1.05rem;
        font-weight: 700;
      }
      .player-score {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .player-score input {
        width: 68px;
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.25);
        background: rgba(255, 255, 255, 0.05);
        color: #fff;
        font-size: 1.2rem;
        text-align: center;
        padding: 6px 8px;
      }
      .player-score input:focus {
        outline: 2px solid rgba(255, 169, 89, 0.7);
      }
      .stroke-indicator {
        width: 20px;
        text-align: center;
        font-weight: 700;
        color: #ffbb00;
      }
      .points-row {
        margin-top: 16px;
        display: flex;
        gap: 12px;
      }
      .points-chip {
        flex: 1;
        background: rgba(76, 209, 255, 0.08);
        border-radius: 12px;
        padding: 10px;
        text-align: center;
      }
      .points-chip strong {
        display: block;
        font-size: 1.5rem;
        margin-top: 6px;
      }
      .save-row {
        display: flex;
        gap: 12px;
      }
      .save-btn,
      .ghost-btn {
        flex: 1;
        border-radius: 12px;
        border: none;
        font-weight: 700;
        font-size: 1rem;
        padding: 12px;
        cursor: pointer;
      }
      .save-btn {
        background: #ff8800;
        color: #fff;
        border: 1px solid #ff8800;
      }
      .save-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      .ghost-btn {
        background: transparent;
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: #fff;
      }
      .note {
        margin: 0;
        font-size: 0.85rem;
        color: rgba(255, 255, 255, 0.6);
        text-align: center;
      }
      .modal {
        position: fixed;
        inset: 0;
        background: rgba(4, 6, 17, 0.85);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10;
      }
      .modal.hidden {
        display: none;
      }
      .modal-card {
        width: min(420px, 90%);
        background: #0b1426;
        border-radius: 18px;
        padding: 20px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
      }
      .modal-card h2 {
        margin: 0 0 10px;
        font-size: 1.3rem;
      }
      .modal-card p {
        margin: 0 0 12px;
        color: rgba(255, 255, 255, 0.7);
        font-size: 0.9rem;
      }
      .match-options {
        display: flex;
        flex-direction: column;
        gap: 10px;
        max-height: 260px;
        overflow-y: auto;
        padding-right: 8px;
      }
      .match-option {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 12px;
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      .match-option input {
        width: 16px;
        height: 16px;
        accent-color: #4cd1ff;
      }
      .match-option strong {
        display: block;
      }
      .match-option span {
        font-size: 0.75rem;
        color: rgba(255, 255, 255, 0.6);
      }
      .modal-actions {
        margin-top: 16px;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
      }
      .modal-actions .btn {
        border-radius: 10px;
        padding: 10px 14px;
        font-weight: 700;
        border: none;
        cursor: pointer;
      }
      .modal-actions .btn.primary {
        background: #4cd1ff;
        color: #051b2c;
      }
      .modal-actions .btn.secondary {
        background: transparent;
        border: 1px solid rgba(255, 255, 255, 0.4);
        color: #fff;
      }
    </style>
  </head>
  <body>
    <div class="mobile-shell">
      <div class="modal hidden" id="match-modal">
        <div class="modal-card">
          <h2>Pick matches to score</h2>
          <p>Select up to two matches that are active or in progress.</p>
          <div class="match-options" id="match-options"></div>
          <div class="modal-actions">
            <button class="btn secondary" id="modal-cancel">Cancel</button>
            <button class="btn primary" id="modal-confirm">Done</button>
          </div>
        </div>
      </div>

      <div class="header">
        <p class="page-title">Mobile Scoring</p>
        <p class="page-subtitle">All score entry happens here, no refresh required.</p>
      </div>

      <div class="hole-bar">
        <button class="hole-nav" id="hole-prev">‹ Hole</button>
        <div class="hole-info">
          <span class="hole-number" id="hole-number">1</span>
          <span class="hole-meta" id="hole-meta">Par — · HCP —</span>
        </div>
        <button class="hole-nav" id="hole-next">Hole ›</button>
      </div>

      <div class="status-row">
        <span class="status-label">Active matches</span>
        <div class="status-pills" id="status-pills"></div>
      </div>

      <div class="match-panels" id="match-panels"></div>

      <div class="save-row">
        <button id="save-scores" class="save-btn">Save Scores</button>
        <button id="change-matches" class="ghost-btn">Change Matches</button>
      </div>

      <p class="note">Hit save to update both matches; standings refresh automatically.</p>
    </div>

    <script>
      const matches = {{ matches | tojson }};
      let summary = {{ scorecard | tojson }};
      let activeHole = 1;
      let activeInput = null;
      let lastValues = {};

      const normalizeSummary = () => {
        summary = summary || {};
        summary.match = summary.match || {};
        summary.holes = summary.holes || [];
        summary.course_holes = summary.course_holes || [];
        summary.player_a_handicap = Number(summary.player_a_handicap || summary.match.player_a_handicap || 0);
        summary.player_b_handicap = Number(summary.player_b_handicap || summary.match.player_b_handicap || 0);
        summary.match.match_key = summary.match.match_key || summary.match_key || "";
        summary.match.match_code = summary.match.match_code || summary.match_code || "";
        summary.match.player_a_name = summary.match.player_a_name || summary.player_a || "Player A";
        summary.match.player_b_name = summary.match.player_b_name || summary.player_b || "Player B";
        summary.match.match_name = summary.match.match_name || summary.match_name || "Match";
      };
      normalizeSummary();

      const matchModal = document.getElementById("match-modal");
      const matchSelect = document.getElementById("match-select");
      const matchConfirm = document.getElementById("match-confirm");
      const mobileStatusEl = document.getElementById("mobile-status");
      const mobileActiveButtons = document.querySelectorAll(".mobile-active-match-btn");
      const changeMatch = document.getElementById("change-match");
      const holeNumberEl = document.getElementById("hole-number");
      const holeSubEl = document.getElementById("hole-sub");
      const matchNameEl = document.getElementById("match-name");
      const matchMetaEl = document.getElementById("match-meta");
      const playerAName = document.getElementById("player-a-name");
      const playerBName = document.getElementById("player-b-name");
      const playerAHcp = document.getElementById("player-a-hcp");
      const playerBHcp = document.getElementById("player-b-hcp");
      const strokeA = document.getElementById("stroke-a");
      const strokeB = document.getElementById("stroke-b");
      const scoreA = document.getElementById("score-a");
      const scoreB = document.getElementById("score-b");

      const holeMeta = (num) => {
        const found = summary.course_holes?.find((h) => Number(h.hole_number) === Number(num));
        return found || {};
      };

      const updateMobileStatus = () => {
        if (!mobileStatusEl) {
          return;
        }
        const label = summary.status_label || "Not started";
        const holesRecorded = summary.holes_recorded || 0;
        mobileStatusEl.textContent = `${label} · ${holesRecorded} holes recorded`;
      };

      const highlightActiveMobileButton = (matchKey) => {
        mobileActiveButtons.forEach((button) => {
          button.classList.toggle("active", button.dataset.matchKey === matchKey);
        });
      };

      const strokesFor = (handicap, holeHandicap) => {
        const base = Math.floor(handicap / 18);
        const rem = handicap % 18;
        return base + (rem && holeHandicap <= rem ? 1 : 0);
      };

      const currentHoleEntry = () => summary.holes.find((h) => Number(h.hole_number) === Number(activeHole));

      const setHole = (num) => {
        activeHole = num;
        holeNumberEl.textContent = num;
        const meta = holeMeta(num);
        holeSubEl.textContent = meta.par ? `Par ${meta.par}${meta.yardage ? " • " + meta.yardage + " yds" : ""}` : "";
        const entry = currentHoleEntry() || {};
        scoreA.value = entry.player_a_score || "";
        scoreB.value = entry.player_b_score || "";
        const hcp = meta.handicap || entry.hole_handicap || 18;
        strokeA.textContent = strokesFor(summary.player_a_handicap, hcp) ? "★".repeat(strokesFor(summary.player_a_handicap, hcp)) : "";
        strokeB.textContent = strokesFor(summary.player_b_handicap, hcp) ? "★".repeat(strokesFor(summary.player_b_handicap, hcp)) : "";
      };

      const record = () => {
        const idx = summary.holes.findIndex((h) => Number(h.hole_number) === Number(activeHole));
        const meta = holeMeta(activeHole);
        const entry = {
          hole_number: activeHole,
          hole_handicap: meta.handicap || 18,
          player_a_score: scoreA.value,
          player_b_score: scoreB.value,
        };
        if (idx >= 0) summary.holes[idx] = entry; else summary.holes.push(entry);
      };

      document.getElementById("hole-prev").onclick = () => setHole(Math.max(1, activeHole - 1));
      document.getElementById("hole-next").onclick = () => setHole(Math.min(18, activeHole + 1));

      [scoreA, scoreB].forEach((inp) => {
        inp.addEventListener("focus", () => activeInput = inp);
        inp.addEventListener("input", record);
      });

      document.getElementById("save").onclick = async () => {
        record();
        const payload = { holes: summary.holes.filter((h) => h.player_a_score !== "" && h.player_b_score !== "") };
        const saveKey = summary.match.match_code || summary.match.match_key;
        await fetch(`/matches/key/${saveKey}/holes`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        lastValues = {};
      };

      const loadMatch = async (matchKey) => {
        try {
          const res = await fetch(`/api/match-summary/${matchKey}`);
          const data = await res.json();
          summary = data;
          normalizeSummary();
        } catch {
          normalizeSummary();
        }
        if (matchSelect) {
          matchSelect.value = matchKey;
        }
        matchNameEl.textContent = summary.match.match_name || "";
        const metaParts = [
          summary.match.match_key ? `Match ${summary.match.match_key}` : "",
          summary.division || "",
          summary.status_label || "",
        ].filter(Boolean);
        matchMetaEl.textContent = metaParts.join(" • ");
        playerAName.textContent = summary.match.player_a_name || "Player A";
        playerBName.textContent = summary.match.player_b_name || "Player B";
        playerAHcp.textContent = `HCP ${summary.player_a_handicap ?? 0}`;
        playerBHcp.textContent = `HCP ${summary.player_b_handicap ?? 0}`;
        activeHole = 1;
        setHole(activeHole);
        updateMobileStatus();
        highlightActiveMobileButton(matchKey);
      };

      if (matchConfirm) {
        matchConfirm.onclick = () => {
          const key = matchSelect.value;
          matchModal.style.display = "none";
          highlightActiveMobileButton(key);
          loadMatch(key);
        };
      }

      if (changeMatch) {
        changeMatch.onclick = () => {
          matchModal.style.display = "flex";
        };
      }

      mobileActiveButtons.forEach((button) => {
        button.addEventListener("click", () => {
          const key = button.dataset.matchKey;
          if (!key) {
            return;
          }
          matchModal.style.display = "none";
          if (matchSelect) {
            matchSelect.value = key;
          }
          highlightActiveMobileButton(key);
          loadMatch(key);
        });
      });

      loadMatch(matchSelect.value);
    </script>
  </body>
</html>
