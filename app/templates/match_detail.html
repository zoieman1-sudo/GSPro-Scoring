{% extends "base.html" %}
{% block content %}
  <section class="card standings-card detail-card">
    <div class="match-meta">
      <p class="eyebrow">Match Detail</p>
      <h1 class="match-title">{{ match.match_name }}</h1>
      <p class="match-sub">
        {{ match.player_a_name }} vs {{ match.player_b_name }} &middot;
        {{ match.submitted_at.strftime('%Y-%m-%d %H:%M:%S') if match.submitted_at else 'Unknown time' }}
      </p>
    </div>
    <div class="match-summary">
      <div>
        <span>Player A</span>
        <strong>{{ match.player_a_name }}</strong>
        <p class="match-score-large">{{ hole_total_a }}</p>
      </div>
      <div>
        <span>Player B</span>
        <strong>{{ match.player_b_name }}</strong>
        <p class="match-score-large">{{ hole_total_b }}</p>
      </div>
      <div class="match-winner-badge">
        Winner: {{ match.player_a_name if match.winner == 'A' else match.player_b_name if match.winner == 'B' else 'Draw' }}
      </div>
    </div>

    <table class="detail-table">
      <thead>
        <tr>
          <th>Hole</th>
          <th>{{ match.player_a_name }}</th>
          <th>{{ match.player_b_name }}</th>
          <th>Diff</th>
        </tr>
      </thead>
      <tbody>
        {% if holes %}
          {% for hole in holes %}
            <tr>
              <td>{{ hole.hole_number }}</td>
              <td>{{ hole.player_a_score }}</td>
              <td>{{ hole.player_b_score }}</td>
              <td>{{ hole.player_a_score - hole.player_b_score }}</td>
            </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="4" class="status">No hole data yet.</td>
          </tr>
        {% endif %}
      </tbody>
    </table>

    <section class="setup-card">
      <div class="setup-head">
        <h2>Add hole scores</h2>
        <p class="match-sub">Enter hole-by-hole numbers for both players and submit to append.</p>
      </div>
      <form id="hole-form" class="setup-form">
        <div id="hole-rows" class="setup-grid">
          <div class="setup-row setup-head-row">
            <span>Hole</span>
            <span>{{ match.player_a_name }}</span>
            <span>{{ match.player_b_name }}</span>
            <span></span>
          </div>
        </div>
        <div class="setup-actions">
          <button type="button" id="add-hole-btn" class="add-player-btn">Add hole</button>
          <button type="submit" class="submit-btn">Save hole scores</button>
        </div>
      </form>
    </section>
  </section>

  <template id="hole-template">
    <div class="setup-row">
      <input type="number" name="hole_number" placeholder="Hole" min="1" required />
      <input type="number" name="player_a_score" placeholder="Player A" min="0" required />
      <input type="number" name="player_b_score" placeholder="Player B" min="0" required />
      <button type="button" class="remove-row-btn" aria-label="Remove hole row">Ã—</button>
    </div>
  </template>

  <script>
    const form = document.getElementById("hole-form");
    const holeContainer = document.getElementById("hole-rows");
    const template = document.getElementById("hole-template");

    const addHoleRow = () => {
      const clone = template.content.cloneNode(true);
      const row = clone.querySelector(".setup-row");
      const removeBtn = row.querySelector(".remove-row-btn");
      removeBtn.addEventListener("click", () => {
        const dataRows = Array.from(holeContainer.querySelectorAll(".setup-row")).filter(
          (candidate) => candidate.querySelectorAll("input").length >= 3
        );
        if (dataRows.length <= 1) {
          return;
        }
        row.remove();
      });
      holeContainer.appendChild(row);
    };

    document.getElementById("add-hole-btn").addEventListener("click", () => addHoleRow());
    addHoleRow();

    form.addEventListener("submit", async (event) => {
      event.preventDefault();
      const rows = Array.from(holeContainer.querySelectorAll(".setup-row"))
        .map((row) => {
          const inputs = row.querySelectorAll("input");
          if (inputs.length < 3) {
            return null;
          }
          return {
            hole_number: inputs[0].value,
            player_a_score: inputs[1].value,
            player_b_score: inputs[2].value,
          };
        })
        .filter(Boolean);

      if (!rows.length) {
        return;
      }

      const response = await fetch(`/matches/{{ match.id }}/holes`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ holes: rows }),
      });
      if (response.ok) {
        location.reload();
      }
    });
  </script>
{% endblock %}
