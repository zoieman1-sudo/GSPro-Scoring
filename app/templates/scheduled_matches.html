{% extends "base.html" %}

{% block content %}
  <section class="card scheduled-matches-panel">
    <div class="match-meta">
      <p class="eyebrow">Scheduled matches</p>

    </div>

    {% macro scheduled_match_card(match, show_finalize=False, show_reset=False) -%}
      <article class="scheduled-match-card{% if match.finalized %} scheduled-match-card--finalized{% endif %}">
        <div class="scheduled-match-card__meta">
          <div>
            <p class="match-player-chip">
              {{ match.course_name or "Course pending" }}
              {% if match.tee_name %} — {{ match.tee_name }}{% endif %}
            </p>
            <span class="muted-label">
              Key: {{ match.match_key }} · {{ match.hole_count }} holes · Start hole {{ match.start_hole }}
            </span>
          </div>
          <span class="scheduled-match-card__status">
            {% if match.finalized %}
              FINALIZED
            {% else %}
              {{ match.status|default("scheduled")|upper }}
            {% endif %}
          </span>
        </div>
        <div class="scheduled-match-card__teams">
          <div>
            <p class="scheduled-match-card__team-label">Players – Slot 1</p>
            <p class="scheduled-match-card__team-names">
              {{ match.player_a_name }}
              {% if match.player_c_name %}
                <span class="scheduled-match-card__bullet">&bull;</span>
                {{ match.player_c_name }}
              {% endif %}
            </p>
          </div>
          <div>
            <p class="scheduled-match-card__team-label">Players – Slot 2</p>
            <p class="scheduled-match-card__team-names">
              {{ match.player_b_name }}
              {% if match.player_d_name %}
                <span class="scheduled-match-card__bullet">&bull;</span>
                {{ match.player_d_name }}
              {% endif %}
            </p>
          </div>
        </div>
        <div class="scheduled-match-card__footer">
          {% if match.tee_yards %}
            <span class="muted-label">{{ match.tee_yards }} yards</span>
          {% endif %}
          <div class="scheduled-match-card__actions">
                <a
                  class="pill-link"
                  href="/golf-ui/scoring.html?match_key={{ match.match_key }}"
                  target="_blank"
                  rel="noreferrer"
                >
              Launch Scorecard
            </a>
            <div class="scheduled-match-card__quick-actions">
              {% if show_finalize %}
                <form
                  data-finalize-match-form="{{ match.id }}"
                  class="match-actions__form"
                  method="post"
                  action="/matches/{{ match.id }}/finalize"
                >
                  <input type="hidden" name="redirect" value="/standings" />
                  <input type="hidden" name="bonus_mode" value="full" />
                  <button
                    type="button"
                    class="pill-link pill-link--finalize"
                    data-finalize-match="{{ match.id }}"
                    data-finalize-match-key="{{ match.match_key }}"
                  >
                    Finalize
                  </button>
                </form>
              {% endif %}
              {% if show_reset %}
                <form
                  class="match-actions__form"
                  method="post"
                  action="/matches/{{ match.id }}/reset"
                >
                  <button
                    class="pill-link pill-link--reset"
                    type="submit"
                  >
                    Reset match
                  </button>
                </form>
              {% endif %}
              <form class="match-actions__form" method="post" action="/admin/match_setup/delete">
                <input type="hidden" name="match_id" value="{{ match.id }}" />
                <button class="pill-link pill-link--remove" type="submit">Remove</button>
              </form>
            </div>
          </div>
        </div>
      </article>
    {%- endmacro %}

    <div class="scheduled-matches-section scheduled-matches-section--active">
      <div class="scheduled-matches-section__header">
        <p class="eyebrow">Active</p>
        <h2 class="match-title scheduled-matches-section__title">Live pairings</h2>
        <p class="match-sub scheduled-matches-section__description">
          Balanced matches are ready to deploy. Launch Scorecard Studio, finalize the results, or remove stale pairings from this board.
        </p>
      </div>
      {% if active_matches %}
        <div class="scheduled-matches-grid">
          {% for match in active_matches %}
            {{ scheduled_match_card(match, show_finalize=True, show_reset=False) }}
          {% endfor %}
        </div>
      {% else %}
        <p class="status">No active matches right now. Create pairings on the match setup screen.</p>
      {% endif %}
    </div>

    <div class="scheduled-matches-section scheduled-matches-section--finalized">
      <div class="scheduled-matches-section__header">
        <p class="eyebrow">Finalized</p>
        <h2 class="match-title scheduled-matches-section__title">Finalized matches</h2>
        <p class="match-sub scheduled-matches-section__description">
          Completed matches land here for review. Reset a match if any scores need correction.
        </p>
      </div>
      {% if finalized_matches %}
        <div class="scheduled-matches-grid">
          {% for match in finalized_matches %}
            {{ scheduled_match_card(match, show_finalize=False, show_reset=True) }}
          {% endfor %}
        </div>
      {% else %}
        <p class="status">No matches have been finalized yet.</p>
      {% endif %}
    </div>
    <div id="finalizeConfirmOverlay" class="finalize-confirm-overlay" role="dialog" aria-modal="true" data-open="false">
      <div class="finalize-confirm-card">
        <h3>Finalize match</h3>
        <p id="finalizeConfirmText">Are you sure you want to finalize this match? This will lock the scores and update the standings.</p>
        <div class="finalize-bonus-options">
          <p class="muted-label">Bonus allocation</p>
          <label class="finalize-bonus-option">
            <input type="radio" name="finalizeBonusOption" value="full" checked />
            <span>Full (winner bonus)</span>
            <small class="muted-label">Award bonus exactly as the scorecard suggests.</small>
          </label>
          <label class="finalize-bonus-option">
            <input type="radio" name="finalizeBonusOption" value="half" />
            <span>Half (shared bonus)</span>
            <small class="muted-label">Split the bonus point ½/½ regardless of winner.</small>
          </label>
          <label class="finalize-bonus-option">
            <input type="radio" name="finalizeBonusOption" value="none" />
            <span>None (no bonus)</span>
            <small class="muted-label">Skip the bonus point entirely.</small>
          </label>
        </div>
        <div class="confirm-actions">
          <button type="button" class="confirm" id="finalizeConfirmYes">Yes</button>
          <button type="button" id="finalizeConfirmCancel">Cancel</button>
        </div>
      </div>
    </div>
    <script>
      (function () {
        const overlay = document.getElementById("finalizeConfirmOverlay");
        const finalizeButtons = document.querySelectorAll("[data-finalize-match]");
        const confirmBtn = document.getElementById("finalizeConfirmYes");
        const cancelBtn = document.getElementById("finalizeConfirmCancel");
        const confirmText = document.getElementById("finalizeConfirmText");
        let pendingMatchId = null;

        const showOverlay = (matchId, matchKey) => {
          if (!overlay) return;
          pendingMatchId = matchId;
          if (confirmText) {
            confirmText.textContent = `Finalize ${matchKey}? This will lock the scores and refresh standings.`;
          }
          overlay.dataset.open = "true";
          overlay.removeAttribute("aria-hidden");
        };

        const hideOverlay = () => {
          if (!overlay) return;
          overlay.dataset.open = "false";
          overlay.setAttribute("aria-hidden", "true");
          pendingMatchId = null;
        };

        finalizeButtons.forEach((button) => {
          button.addEventListener("click", (event) => {
            event.preventDefault();
            const matchId = button.getAttribute("data-finalize-match");
            const matchKey = button.getAttribute("data-finalize-match-key") || "match";
            if (matchId) {
              showOverlay(matchId, matchKey);
            }
          });
        });

        confirmBtn?.addEventListener("click", () => {
          if (!pendingMatchId) return;
          const form = document.querySelector(`[data-finalize-match-form="${pendingMatchId}"]`);
          if (form) {
            const selectedBonus = (() => {
              const active = overlay?.querySelector('[name="finalizeBonusOption"]:checked');
              return active ? active.value : "full";
            })();
            let bonusInput = form.querySelector('input[name="bonus_mode"]');
            if (!bonusInput) {
              bonusInput = document.createElement("input");
              bonusInput.type = "hidden";
              bonusInput.name = "bonus_mode";
              form.appendChild(bonusInput);
            }
            bonusInput.value = selectedBonus;
            form.submit();
          }
        });
        cancelBtn?.addEventListener("click", hideOverlay);
      })();
    </script>
  </section>
{% endblock %}
