{% extends "base.html" %}

{% block content %}
  <section class="card scheduled-matches-panel">
    <div class="match-meta">
      <p class="eyebrow">Scheduled matches</p>

    </div>

    {% macro scheduled_match_card(match, show_finalize=False, show_reset=False) -%}
      <article class="scheduled-match-card{% if match.finalized %} scheduled-match-card--finalized{% endif %}">
        <div class="scheduled-match-card__meta">
          <div>
            <p class="match-player-chip">
              {{ match.course_name or "Course pending" }}
              {% if match.tee_name %} — {{ match.tee_name }}{% endif %}
            </p>
            <span class="muted-label">
              Key: {{ match.match_key }} · {{ match.hole_count }} holes · Start hole {{ match.start_hole }}
            </span>
          </div>
          <span class="scheduled-match-card__status">
            {% if match.finalized %}
              FINALIZED
            {% else %}
              {{ match.status|default("scheduled")|upper }}
            {% endif %}
          </span>
        </div>
        <div class="scheduled-match-card__teams">
          <div>
            <p class="scheduled-match-card__team-label">Players – Slot 1</p>
            <p class="scheduled-match-card__team-names">
              {{ match.player_a_name }}
              {% if match.player_c_name %}
                <span class="scheduled-match-card__bullet">&bull;</span>
                {{ match.player_c_name }}
              {% endif %}
            </p>
          </div>
          <div>
            <p class="scheduled-match-card__team-label">Players – Slot 2</p>
            <p class="scheduled-match-card__team-names">
              {{ match.player_b_name }}
              {% if match.player_d_name %}
                <span class="scheduled-match-card__bullet">&bull;</span>
                {{ match.player_d_name }}
              {% endif %}
            </p>
          </div>
        </div>
        <div class="scheduled-match-card__footer">
          {% if match.tee_yards %}
            <span class="muted-label">{{ match.tee_yards }} yards</span>
          {% endif %}
          <div class="scheduled-match-card__actions">
                <a
                  class="pill-link"
                  href="/golf-ui/scoring.html?match_key={{ match.match_key }}"
                  target="_blank"
                  rel="noreferrer"
                >
              Launch Scorecard
            </a>
            <div class="scheduled-match-card__quick-actions">
              {% if show_finalize %}
                <button
                  type="button"
                  class="pill-link pill-link--finalize"
                  data-finalize-match-id="{{ match.id }}"
                  data-finalize-match-key="{{ match.match_key }}"
                >
                  Finalize
                </button>
              {% endif %}
              {% if show_reset %}
                <form
                  class="match-actions__form"
                  method="post"
                  action="/matches/{{ match.id }}/reset"
                >
                  <button
                    class="pill-link pill-link--reset"
                    type="submit"
                  >
                    Reset match
                  </button>
                </form>
              {% endif %}
              <form class="match-actions__form" method="post" action="/admin/match_setup/delete">
                <input type="hidden" name="match_id" value="{{ match.id }}" />
                <button class="pill-link pill-link--remove" type="submit">Remove</button>
              </form>
            </div>
          </div>
        </div>
      </article>
    {%- endmacro %}

    <div class="scheduled-matches-section scheduled-matches-section--active">
      <div class="scheduled-matches-section__header">
        <p class="eyebrow">Active</p>
        <h2 class="match-title scheduled-matches-section__title">Live pairings</h2>
        <p class="match-sub scheduled-matches-section__description">
          Balanced matches are ready to deploy. Launch Scorecard Studio, finalize the results, or remove stale pairings from this board.
        </p>
      </div>
      {% if active_matches %}
        <div class="scheduled-matches-grid">
          {% for match in active_matches %}
            {{ scheduled_match_card(match, show_finalize=True, show_reset=False) }}
          {% endfor %}
        </div>
      {% else %}
        <p class="status">No active matches right now. Create pairings on the match setup screen.</p>
      {% endif %}
    </div>

    <div class="scheduled-matches-section scheduled-matches-section--finalized">
      <div class="scheduled-matches-section__header">
        <p class="eyebrow">Finalized</p>
        <h2 class="match-title scheduled-matches-section__title">Finalized matches</h2>
        <p class="match-sub scheduled-matches-section__description">
          Completed matches land here for review. Reset a match if any scores need correction.
        </p>
      </div>
      {% if finalized_matches %}
        <div class="scheduled-matches-grid">
          {% for match in finalized_matches %}
            {{ scheduled_match_card(match, show_finalize=False, show_reset=True) }}
          {% endfor %}
        </div>
      {% else %}
        <p class="status">No matches have been finalized yet.</p>
      {% endif %}
    </div>
  </section>
  <script>
    (function () {
      const finalizeButtons = document.querySelectorAll("[data-finalize-match-id]");
      finalizeButtons.forEach((button) => {
        button.addEventListener("click", async () => {
          if (
            !confirm(
              "Finalizing locks the course, hole data, and points so they cannot change. Continue?"
            )
          ) {
            return;
          }
          button.disabled = true;
          try {
            const response = await fetch(`/matches/${button.dataset.finalizeMatchId}/finalize`, {
              method: "POST",
              headers: {
                "Content-Type": "application/x-www-form-urlencoded",
              },
              body: new URLSearchParams({ redirect: "/admin/scheduled_matches" }).toString(),
            });
            if (!response.ok) {
              const error = await response.json().catch(() => ({}));
              throw new Error(error.detail || "Unable to finalize the match.");
            }
            window.location.reload();
          } catch (error) {
            alert(error.message || "Unable to finalize the match.");
            button.disabled = false;
          }
        });
      });
    })();
  </script>
{% endblock %}
