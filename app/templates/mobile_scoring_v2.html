<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>Mobile Scoring</title>
    <style>
      :root {
        font-family: "Inter", system-ui, -apple-system, sans-serif;
        color: #f5f7ff;
      }
      body {
        margin: 0;
        font-size: 16px;
        background: #050811;
      }
      .mobile-shell {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        gap: 12px;
        padding: 16px;
        background: linear-gradient(180deg, #040612 0%, #070b1c 60%, #05060f 100%);
      }
      .header {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }
      .page-title {
        margin: 0;
        font-size: 1.3rem;
        letter-spacing: 0.05em;
      }
      .page-subtitle {
        margin: 0;
        font-size: 0.95rem;
        color: rgba(255, 255, 255, 0.7);
      }
      .hole-bar {
        display: grid;
        grid-template-columns: auto 1fr auto;
        align-items: center;
        background: #10223a;
        border-radius: 14px;
        padding: 10px 14px;
        gap: 8px;
        box-shadow: inset 0 0 30px rgba(6, 13, 33, 0.6);
      }
      .hole-nav {
        border: 1px solid rgba(255, 255, 255, 0.2);
        background: transparent;
        color: #f5f7ff;
        border-radius: 12px;
        padding: 6px 10px;
        font-weight: 700;
        cursor: pointer;
      }
      .hole-info {
        text-align: center;
      }
      .hole-number {
        display: block;
        font-size: 1.1rem;
        font-weight: 700;
      }
      .hole-meta {
        display: block;
        font-size: 0.9rem;
        color: rgba(255, 255, 255, 0.7);
      }
      .status-row {
        background: #0d1323;
        border-radius: 14px;
        padding: 12px 14px;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .status-label {
        font-size: 0.85rem;
        letter-spacing: 0.2em;
        text-transform: uppercase;
        color: rgba(255, 255, 255, 0.7);
      }
      .status-pills {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }
      .pill {
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 12px;
        padding: 6px 10px;
        min-width: 130px;
      }
      .pill strong {
        display: block;
        font-size: 0.95rem;
      }
      .pill span {
        display: block;
        font-size: 0.75rem;
        color: rgba(255, 255, 255, 0.6);
      }
      .match-panels {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 12px;
      }
      .match-panel {
        background: #0b1426;
        border-radius: 18px;
        padding: 16px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      .match-panel + .match-panel {
        border-top: 2px solid rgba(255, 255, 255, 0.08);
      }
      .panel-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 12px;
      }
      .panel-division {
        margin: 0;
        font-size: 0.8rem;
        letter-spacing: 0.3em;
        text-transform: uppercase;
        color: rgba(255, 255, 255, 0.5);
      }
      .panel-match-name {
        margin: 4px 0 0;
        font-size: 1.05rem;
        font-weight: 700;
      }
      .panel-status {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.2em;
        color: rgba(255, 255, 255, 0.6);
      }
      .player-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 0;
      }
      .player-row + .player-row {
        border-top: 1px solid rgba(255, 255, 255, 0.05);
      }
      .player-info {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }
      .player-name {
        margin: 0;
        font-size: 1.05rem;
        font-weight: 700;
      }
      .player-score {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .player-score input {
        width: 68px;
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.25);
        background: rgba(255, 255, 255, 0.05);
        color: #fff;
        font-size: 1.2rem;
        text-align: center;
        padding: 6px 8px;
      }
      .player-score input:focus {
        outline: 2px solid rgba(255, 169, 89, 0.7);
      }
      .stroke-indicator {
        width: 20px;
        text-align: center;
        font-weight: 700;
        color: #ffbb00;
      }
      .points-row {
        margin-top: 16px;
        display: flex;
        gap: 12px;
      }
      .points-chip {
        flex: 1;
        background: rgba(76, 209, 255, 0.08);
        border-radius: 12px;
        padding: 10px;
        text-align: center;
      }
      .points-chip strong {
        display: block;
        font-size: 1.5rem;
        margin-top: 6px;
      }
      .save-row {
        display: flex;
        gap: 12px;
      }
      .save-btn,
      .ghost-btn {
        flex: 1;
        border-radius: 12px;
        border: none;
        font-weight: 700;
        font-size: 1rem;
        padding: 12px;
        cursor: pointer;
      }
      .save-btn {
        background: #ff8800;
        color: #fff;
        border: 1px solid #ff8800;
      }
      .save-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      .ghost-btn {
        background: transparent;
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: #fff;
      }
      .note {
        margin: 0;
        font-size: 0.85rem;
        color: rgba(255, 255, 255, 0.6);
        text-align: center;
      }
      .modal {
        position: fixed;
        inset: 0;
        background: rgba(4, 6, 17, 0.85);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10;
      }
      .modal.hidden {
        display: none;
      }
      .modal-card {
        width: min(420px, 90%);
        background: #0b1426;
        border-radius: 18px;
        padding: 20px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
      }
      .modal-card h2 {
        margin: 0 0 10px;
        font-size: 1.3rem;
      }
      .modal-card p {
        margin: 0 0 12px;
        color: rgba(255, 255, 255, 0.7);
        font-size: 0.9rem;
      }
      .match-options {
        display: flex;
        flex-direction: column;
        gap: 10px;
        max-height: 260px;
        overflow-y: auto;
        padding-right: 8px;
      }
      .match-option {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 12px;
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      .match-option input {
        width: 16px;
        height: 16px;
        accent-color: #4cd1ff;
      }
      .match-option strong {
        display: block;
      }
      .match-option span {
        font-size: 0.75rem;
        color: rgba(255, 255, 255, 0.6);
      }
      .modal-actions {
        margin-top: 16px;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
      }
      .modal-actions .btn {
        border-radius: 10px;
        padding: 10px 14px;
        font-weight: 700;
        border: none;
        cursor: pointer;
      }
      .modal-actions .btn.primary {
        background: #4cd1ff;
        color: #051b2c;
      }
      .modal-actions .btn.secondary {
        background: transparent;
        border: 1px solid rgba(255, 255, 255, 0.4);
        color: #fff;
      }
    </style>
  </head>
  <body>
    <div class="mobile-shell">
      <div class="modal hidden" id="match-modal">
        <div class="modal-card">
          <h2>Pick matches to score</h2>
          <p>Select up to two matches that are active or in progress.</p>
          <div class="match-options" id="match-options"></div>
          <div class="modal-actions">
            <button class="btn secondary" id="modal-cancel">Cancel</button>
            <button class="btn primary" id="modal-confirm">Done</button>
          </div>
        </div>
      </div>

      <div class="header">
        <p class="page-title">Mobile Scoring</p>
        <p class="page-subtitle">All score entry happens here, no refresh required.</p>
      </div>

      <div class="hole-bar">
        <button class="hole-nav" id="hole-prev">‹ Hole</button>
        <div class="hole-info">
          <span class="hole-number" id="hole-number">1</span>
          <span class="hole-meta" id="hole-meta">Par — · HCP —</span>
        </div>
        <button class="hole-nav" id="hole-next">Hole ›</button>
      </div>

      <div class="status-row">
        <span class="status-label">Active matches</span>
        <div class="status-pills" id="status-pills"></div>
      </div>

      <div class="match-panels" id="match-panels"></div>

      <div class="save-row">
        <button id="save-scores" class="save-btn">Save Scores</button>
        <button id="change-matches" class="ghost-btn">Change Matches</button>
      </div>

      <p class="note">Hit save to update both matches; standings refresh automatically.</p>
    </div>

    <script>
      const matches = {{ matches | tojson }};
      const defaultMatchKeys = {{ default_match_keys | tojson }};
      const initialSummary = {{ scorecard | tojson }};
      const MAX_SELECTION = 2;

      const state = {
        selectedKeys: [],
        matchStates: {},
        holeNumber: 1,
        totalHoles: 18,
      };

      const matchModal = document.getElementById("match-modal");
      const matchOptions = document.getElementById("match-options");
      const modalConfirm = document.getElementById("modal-confirm");
      const modalCancel = document.getElementById("modal-cancel");
      const statusPillsEl = document.getElementById("status-pills");
      const matchPanelsEl = document.getElementById("match-panels");
      const holeNumberEl = document.getElementById("hole-number");
      const holeMetaEl = document.getElementById("hole-meta");
      const holePrev = document.getElementById("hole-prev");
      const holeNext = document.getElementById("hole-next");
      const saveButton = document.getElementById("save-scores");
      const changeMatchesBtn = document.getElementById("change-matches");

      const ensureMatchState = (key) => {
        if (!state.matchStates[key]) {
          state.matchStates[key] = {
            matchKey: key,
            summary: null,
            holeScores: {},
            loading: false,
            error: false,
          };
        }
        return state.matchStates[key];
      };

      const buildHoleMap = (summary) => {
        const map = {};
        (summary?.holes || []).forEach((hole) => {
          map[hole.hole_number] = {
            player_a_score: hole.gross_a ?? null,
            player_b_score: hole.gross_b ?? null,
          };
        });
        return map;
      };

      const seedInitialSummary = () => {
        if (!initialSummary?.match?.match_key) {
          return;
        }
        const entry = ensureMatchState(initialSummary.match.match_key);
        entry.summary = initialSummary;
        entry.holeScores = buildHoleMap(initialSummary);
      };

      const openModal = () => matchModal.classList.remove("hidden");
      const closeModal = () => matchModal.classList.add("hidden");

      const renderMatchOptions = () => {
        matchOptions.innerHTML = matches
          .map((match) => {
            const checked = state.selectedKeys.includes(match.match_key) ? "checked" : "";
            return `
              <label class="match-option">
                <input type="checkbox" value="${match.match_key}" ${checked} />
                <div>
                  <strong>${match.display}</strong>
                  <span>${match.status_label} · ${match.holes} holes recorded</span>
                </div>
              </label>
            `;
          })
          .join("");
      };

      const loadMatchSummary = async (matchKey) => {
        const entry = ensureMatchState(matchKey);
        if (entry.loading) {
          return;
        }
        entry.loading = true;
        entry.error = false;
        renderUI();
        try {
          const response = await fetch(`/api/match-summary/${matchKey}`);
          if (!response.ok) {
            throw new Error("summary fetch failed");
          }
          const data = await response.json();
          entry.summary = data;
          entry.holeScores = buildHoleMap(data);
          entry.loading = false;
          entry.error = false;
          updateTotalHoles();
          renderUI();
        } catch (err) {
          entry.loading = false;
          entry.error = true;
          renderUI();
        }
      };

      const applySelection = (keys) => {
        state.selectedKeys = keys.slice(0, MAX_SELECTION);
        state.holeNumber = 1;
        updateTotalHoles();
        renderMatchOptions();
        state.selectedKeys.forEach((key) => {
          const entry = ensureMatchState(key);
          if (!entry.summary) {
            loadMatchSummary(key);
          }
        });
        renderUI();
      };

      const getHoleInfo = () => {
        for (const key of state.selectedKeys) {
          const summary = state.matchStates[key]?.summary;
          const course = summary?.course || [];
          const hole = course.find((row) => row.hole_number === state.holeNumber);
          if (hole) {
            return hole;
          }
        }
        return null;
      };

      const updateHoleMeta = () => {
        const holeInfo = getHoleInfo();
        const par = holeInfo?.par ?? "—";
        const hcp = holeInfo?.handicap ?? "—";
        holeNumberEl.textContent = state.holeNumber;
        holeMetaEl.textContent = `Par ${par} · HCP ${hcp}`;
      };

      const renderStatusPills = () => {
        if (!state.selectedKeys.length) {
          statusPillsEl.innerHTML = '<span class="pill">Select matches to start scoring.</span>';
          return;
        }
        statusPillsEl.innerHTML = state.selectedKeys
          .map((key) => {
            const entry = state.matchStates[key];
            const summary = entry?.summary;
            const name = summary?.match?.match_name || key;
            const status = summary?.status_label || "Loading";
            const holes = summary?.holes_recorded ?? 0;
            return `
              <div class="pill">
                <strong>${name}</strong>
                <span>${status} · ${holes} holes recorded</span>
              </div>
            `;
          })
          .join("");
      };

      const formatPoints = (value) => {
        if (value === undefined || value === null) {
          return "0";
        }
        const num = Number(value);
        if (Number.isFinite(num)) {
          return Number.isInteger(num) ? `${num}` : num.toFixed(1);
        }
        return String(value);
      };

      const renderMatchPanel = (matchKey) => {
        const entry = state.matchStates[matchKey];
        if (!entry) {
          return `<section class="match-panel">Loading ${matchKey}…</section>`;
        }
        if (entry.loading) {
          return `<section class="match-panel">Loading match…</section>`;
        }
        if (entry.error) {
          return `
            <section class="match-panel">
              <p>Unable to load match ${matchKey}.</p>
              <button class="ghost-btn reload-match" data-match-key="${matchKey}">Retry</button>
            </section>
          `;
        }
        const summary = entry.summary;
        const holeRow = (summary?.holes || []).find((hole) => hole.hole_number === state.holeNumber) || {};
        const playerAScore = entry.holeScores[state.holeNumber]?.player_a_score ?? "";
        const playerBScore = entry.holeScores[state.holeNumber]?.player_b_score ?? "";
        const strokeA = holeRow.strokes_a > 0 ? "*" : "";
        const strokeB = holeRow.strokes_b > 0 ? "*" : "";
        return `
          <section class="match-panel" data-match-key="${matchKey}">
            <div class="panel-header">
                <div>
                  <span class="panel-division">Division ${summary?.division || "—"}</span>
                  <p class="panel-match-name">
                    ${summary?.match?.player_a_name || "Player A"} - HCP ${summary?.player_a_handicap ?? 0}
                    vs
                    ${summary?.match?.player_b_name || "Player B"} - HCP ${summary?.player_b_handicap ?? 0}
                  </p>
                </div>
              <span class="panel-status">${summary?.status_label || "TBD"}</span>
            </div>
            <div class="player-row">
              <div class="player-info">
                <p class="player-name">${summary?.match?.player_a_name || "Player A"} - HCP ${summary?.player_a_handicap ?? 0}</p>
                <span class="player-hcp">Hole ${state.holeNumber}</span>
              </div>
              <div class="player-score">
                <input class="score-input" data-match-key="${matchKey}" data-player="A" inputmode="numeric" pattern="[0-9]*" value="${playerAScore ?? ""}" />
                <span class="stroke-indicator">${strokeA}</span>
              </div>
            </div>
            <div class="player-row">
              <div class="player-info">
                <p class="player-name">${summary?.match?.player_b_name || "Player B"} - HCP ${summary?.player_b_handicap ?? 0}</p>
                <span class="player-hcp">Hole ${state.holeNumber}</span>
              </div>
              <div class="player-score">
                <input class="score-input" data-match-key="${matchKey}" data-player="B" inputmode="numeric" pattern="[0-9]*" value="${playerBScore ?? ""}" />
                <span class="stroke-indicator">${strokeB}</span>
              </div>
            </div>
            <div class="points-row">
              <div class="points-chip">
                <span>${summary?.match?.player_a_name || "Player A"}</span>
                <strong>${formatPoints(summary?.meta?.total_points_a)}</strong>
              </div>
              <div class="points-chip">
                <span>${summary?.match?.player_b_name || "Player B"}</span>
                <strong>${formatPoints(summary?.meta?.total_points_b)}</strong>
              </div>
            </div>
          </section>
        `;
      };

      const renderMatchPanels = () => {
        if (!state.selectedKeys.length) {
          matchPanelsEl.innerHTML = '<p class="note">Use the button below to choose the matches you want to score.</p>';
          return;
        }
        matchPanelsEl.innerHTML = state.selectedKeys.map((key) => renderMatchPanel(key)).join("");
        attachInputListeners();
      };

      const attachInputListeners = () => {
        matchPanelsEl.querySelectorAll(".score-input").forEach((input) => {
          input.addEventListener("input", handleScoreInput);
        });
        matchPanelsEl.querySelectorAll(".reload-match").forEach((button) => {
          button.addEventListener("click", () => loadMatchSummary(button.dataset.matchKey));
        });
      };

      const handleScoreInput = (event) => {
        const matchKey = event.target.dataset.matchKey;
        const player = event.target.dataset.player;
        const entry = ensureMatchState(matchKey);
        const hole = state.holeNumber;
        if (!entry.holeScores[hole]) {
          entry.holeScores[hole] = {};
        }
        const value = event.target.value.trim();
        const numeric = value === "" ? null : Number(value);
        const field = player === "A" ? "player_a_score" : "player_b_score";
        entry.holeScores[hole][field] = Number.isFinite(numeric) ? numeric : null;
      };

      const updateTotalHoles = () => {
        const counts = state.selectedKeys.map((key) => state.matchStates[key]?.summary?.match?.total_holes || 18);
        state.totalHoles = counts.length ? Math.max(...counts) : 18;
        if (state.holeNumber > state.totalHoles) {
          state.holeNumber = state.totalHoles;
        }
        updateHoleMeta();
      };

      const renderUI = () => {
        renderStatusPills();
        updateHoleMeta();
        renderMatchPanels();
      };

      const collectPayload = (matchKey) => {
        const entry = state.matchStates[matchKey];
        const payload = [];
        Object.entries(entry.holeScores).forEach(([holeNumber, values]) => {
          const holeNum = Number(holeNumber);
          if (!holeNum) {
            return;
          }
          const record = { hole_number: holeNum };
          if (values.player_a_score !== null && values.player_a_score !== undefined) {
            record.player_a_score = values.player_a_score;
          }
          if (values.player_b_score !== null && values.player_b_score !== undefined) {
            record.player_b_score = values.player_b_score;
          }
          if (record.player_a_score === undefined && record.player_b_score === undefined) {
            return;
          }
          payload.push(record);
        });
        return payload;
      };

      const handleSaveScores = async () => {
        if (!state.selectedKeys.length) {
          return;
        }
        saveButton.disabled = true;
        for (const key of state.selectedKeys) {
          const holes = collectPayload(key);
          if (!holes.length) {
            continue;
          }
          try {
            await fetch(`/matches/key/${key}/holes`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ holes }),
            });
            await loadMatchSummary(key);
          } catch (error) {
            console.error(error);
          }
        }
        saveButton.disabled = false;
      };

      matchOptions.addEventListener("change", (event) => {
        if (event.target.matches("input[type='checkbox']")) {
          const checked = matchOptions.querySelectorAll("input[type='checkbox']:checked");
          if (checked.length > MAX_SELECTION) {
            event.target.checked = false;
          }
        }
      });

      modalConfirm.addEventListener("click", () => {
        const checked = Array.from(matchOptions.querySelectorAll("input[type='checkbox']:checked")).map((input) => input.value);
        if (!checked.length) {
          return;
        }
        applySelection(checked);
        closeModal();
      });

      modalCancel.addEventListener("click", () => {
        closeModal();
      });

      changeMatchesBtn.addEventListener("click", () => {
        openModal();
      });

      saveButton.addEventListener("click", () => {
        handleSaveScores();
      });

      holePrev.addEventListener("click", () => {
        if (state.holeNumber > 1) {
          state.holeNumber -= 1;
          renderUI();
        }
      });

      holeNext.addEventListener("click", () => {
        if (state.holeNumber < state.totalHoles) {
          state.holeNumber += 1;
          renderUI();
        }
      });

      const initialize = () => {
        seedInitialSummary();
        renderMatchOptions();
        const keys = defaultMatchKeys.filter((key) => matches.some((match) => match.match_key === key));
        const selected = keys.slice(0, MAX_SELECTION);
        if (!selected.length && initialSummary?.match?.match_key) {
          selected.push(initialSummary.match.match_key);
        }
        if (!selected.length && matches.length) {
          selected.push(matches[0].match_key);
        }
        applySelection(selected);
        if (!selected.length) {
          openModal();
        } else {
          closeModal();
        }
      };

      renderMatchOptions();
      initialize();
    </script>
  </body>
</html>
