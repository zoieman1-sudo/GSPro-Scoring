{% extends "base.html" %}
{% block content %}
  {% set sections = [
    ("parameters", "Tournament Sheet"),
    ("players", "Players & Handicaps"),
    ("course", "Course Import"),
    ("holes", "Holes"),
    ("tees", "Tees"),
    ("pairings", "Pairings"),
  ] %}
  {% set section_labels = dict(sections) %}
  {% set active_label = section_labels.get(active_section, "Tournament Setup") %}
  <section class="card admin-card setup-shell">
    <div class="setup-hero">
      <div class="setup-hero__intro">
        <p class="eyebrow">Admin · Tournament Setup</p>
        <h1 class="match-title">{{ active_label }}</h1>
        {% if active_tournament %}

        {% elif active_tournament_id %}
          <p class="setup-hero__sub">Command center ready. Active tournament {{ active_tournament_id }} cannot be located.</p>
        {% else %}
          <p class="setup-hero__sub">Define the tournament flow, import courses, and build matchups from here.</p>
        {% endif %}
      </div>
      <div class="setup-hero__status">
        {% if setup_status %}
          <span class="status-pill">{{ setup_status }}</span>
        {% else %}
          <span class="status-pill status-pill--muted">All systems Normal</span>
        {% endif %}
        {% if active_tournament %}
          <span class="status-pill status-pill--accent">Active: {{ active_tournament.name }}</span>
        {% endif %}
      </div>
    </div>
    <div class="setup-content">
      {% if active_section == "players" %}
        <div class="match-meta">
          <h2 class="match-title">Players &amp; Handicaps</h2>
          <p class="match-sub">Configure divisions, handicaps, and seeds for every player.</p>
        </div>
        <form class="setup-form" method="post" action="/admin/setup">
          {% set roster_target = player_roster_size %}
          {% if players|length > roster_target %}
            {% set roster_target = players|length %}
          {% endif %}
          {% set extra_slots = roster_target - players|length %}
          <div id="player-list">
            {% for player in players %}
              <div class="setup-row">
                <input type="hidden" name="player_id" value="{{ player.id }}" />
                <input class="setup-input" name="player_name" value="{{ player.name }}" placeholder="Name" required />
                <input class="setup-input" name="player_division" value="{{ player.division }}" placeholder="Division" />
                <input class="setup-input" name="player_seed" value="{{ player.seed }}" placeholder="Seed" inputmode="numeric" />
                <input class="setup-input" name="player_handicap" value="{{ player.handicap }}" placeholder="Handicap" inputmode="numeric" />
                <button type="button" class="remove-row-btn" aria-label="Remove player">✕</button>
              </div>
            {% endfor %}
            {% for _ in range(extra_slots) %}
              <div class="setup-row">
                <input type="hidden" name="player_id" value="" />
                <input class="setup-input" name="player_name" placeholder="Name" />
                <input class="setup-input" name="player_division" placeholder="Division" />
                <input class="setup-input" name="player_seed" placeholder="Seed" inputmode="numeric" />
                <input class="setup-input" name="player_handicap" placeholder="Handicap" inputmode="numeric" />
                <button type="button" class="remove-row-btn" aria-label="Remove player">✕</button>
              </div>
            {% endfor %}
          </div>
          <div class="setup-actions">
            <button type="button" id="add-player-btn" class="add-player-btn">Add player</button>
            <button type="submit" class="submit-btn">Save players</button>
          </div>
        </form>
        <template id="player-row-template">
          <div class="setup-row">
            <input type="hidden" name="player_id" value="" />
            <input class="setup-input" name="player_name" placeholder="Name" />
            <input class="setup-input" name="player_division" placeholder="Division" />
            <input class="setup-input" name="player_seed" placeholder="Seed" inputmode="numeric" />
            <input class="setup-input" name="player_handicap" placeholder="Handicap" inputmode="numeric" />
            <button type="button" class="remove-row-btn" aria-label="Remove player">✕</button>
          </div>
        </template>
      {% elif active_section == "course" %}
      <div class="match-meta">

      </div>
      <div class="course-import-grid">
        <div class="course-import-panel">
          <div class="course-import__header">
            <h3>Live import</h3>
            <p class="match-sub">Search for course data, preview the male tees, and push it to the catalog in one go.</p>
          </div>
          <div class="course-search-row">
            <label class="settings-field">
              <span>Search course (API)</span>
              <input type="text" id="course-search-query" placeholder="Search by course or club name" />
            </label>
            <button type="button" class="submit-btn" id="course-search-btn">Fetch</button>
          </div>
          <div id="course-search-results" class="course-results"></div>
        </div>
        <div class="course-manual-panel">
          <div class="course-illustration" aria-hidden="true"></div>
          <div class="course-manual__body">
            <h3>Manual add</h3>
            <p class="match-sub">Need a course that is not yet in the API? Build it manually with tee data and hole layouts.</p>
            <div class="setup-actions">
              <a class="pill-link pill-link--ghost" href="/admin/courses/new{% if pin %}?pin={{ pin }}{% endif %}">
                Add course manually
              </a>
            </div>
          </div>
        </div>
      </div>
      {% elif active_section == "holes" %}
        <div class="match-meta">
          <h2 class="match-title">Holes</h2>
          <p class="match-sub">Front/back layout from the active course selection.</p>
        </div>
        {% if course_holes %}
          <div class="hole-grid">
            <div>
              <h3>Front 9</h3>
              <div class="hole-table">
                <div class="hole-row hole-head">
                  <span>Hole</span><span>Par</span><span>Handicap</span><span>Yardage</span>
                </div>
                {% for hole in course_holes[:9] %}
                  <div class="hole-row">
                    <span>{{ hole.hole_number }}</span>
                    <span>{{ hole.par }}</span>
                    <span>{{ hole.handicap }}</span>
                    <span>{{ hole.yardage or "—" }}</span>
                  </div>
                {% endfor %}
              </div>
            </div>
            <div>
              <h3>Back 9</h3>
              <div class="hole-table">
                <div class="hole-row hole-head">
                  <span>Hole</span><span>Par</span><span>Handicap</span><span>Yardage</span>
                </div>
                {% for hole in course_holes[9:18] %}
                  <div class="hole-row">
                    <span>{{ hole.hole_number }}</span>
                    <span>{{ hole.par }}</span>
                    <span>{{ hole.handicap }}</span>
                    <span>{{ hole.yardage or "—" }}</span>
                  </div>
                {% endfor %}
              </div>
            </div>
          </div>
        {% else %}
          <p class="status">No hole data found. Import a course first.</p>
        {% endif %}
      {% elif active_section == "tees" %}
        <div class="match-meta">
          <h2 class="match-title">Tees</h2>
          <p class="match-sub">Male tees imported for the selected course.</p>
        </div>
        {% if selected_course %}
          {% set tees = selected_course.tees | selectattr("gender", "equalto", "male") | list %}
          {% if tees %}
            <div class="tee-list">
              {% for tee in tees %}
                <div class="tee-card">
                  <h3>{{ tee.tee_name }}</h3>
                  <p class="match-sub">{{ tee.course_rating or "N/A" }} / {{ tee.slope_rating or "N/A" }} | Par {{ tee.par_total or "—" }}</p>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <p class="status">No male tees imported yet. Use Course Selection to import.</p>
          {% endif %}
        {% else %}
          <p class="status">Select a course first to view its tees.</p>
        {% endif %}
      {% elif active_section == "pairings" %}
        <div class="match-meta">
          <h2 class="match-title">Pairings</h2>
          <p class="match-sub">Round-robin pairings by division.</p>
        </div>
        {% if pairings %}
          <div class="pairings-list">
            {% set current_division = None %}
            {% for pairing in pairings %}
              {% if pairing.division != current_division %}
                {% set current_division = pairing.division %}
                <p class="pairings-division">Division {{ pairing.division }}</p>
              {% endif %}
              <div class="pairings-row">
                <span class="pairings-id">{{ pairing.match_id }}</span>
                <span>{{ pairing.player_a }} vs {{ pairing.player_b }}</span>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <p class="status">Add players to generate pairings.</p>
        {% endif %}
      {% else %}
        <div class="match-meta">
          <h2 class="match-title">Tournament Sheet Parameters</h2>
          <p class="match-sub">Defaults for the Net Match Play sheet. This is the starting view.</p>
        </div>
        <form class="settings-form" method="post" action="/admin/setup/settings">
          <div class="settings-grid">
            {% for key, label in [
              ("a_handicap_index", "A Handicap Index"),
              ("b_handicap_index", "B Handicap Index"),
              ("match_allowance", "Match Allowance %"),
              ("a_tee_slope", "A Tee Slope"),
              ("b_tee_slope", "B Tee Slope"),
              ("a_course_rating", "A Course Rating"),
              ("b_course_rating", "B Course Rating"),
              ("a_par", "A Par"),
              ("b_par", "B Par"),
            ] %}
              <label class="settings-field">
                <span>{{ label }}</span>
                <input
                  type="text"
                  name="{{ key }}"
                  value="{{ tournament_settings[key] }}"
                  placeholder="Enter {{ label|lower }}"
                />
              </label>
            {% endfor %}
          </div>
          <div class="setup-actions">
            <button type="submit" class="submit-btn">Save tournament parameters</button>
          </div>
        </form>
      {% endif %}
    </div>
  </section>

  {% if active_section == "players" %}
    <script>
      const addButton = document.getElementById("add-player-btn");
      const playerList = document.getElementById("player-list");
      const template = document.getElementById("player-row-template");

      const removeRow = (button) => {
        button.closest(".setup-row")?.remove();
      };

      document.addEventListener("click", (event) => {
        if (event.target.matches(".remove-row-btn")) {
          removeRow(event.target);
        }
      });

      if (addButton && template && playerList) {
        addButton.addEventListener("click", () => {
          const clone = template.content.cloneNode(true);
          playerList.appendChild(clone);
        });
      }
    </script>
  {% elif active_section == "course" %}
    <script>
      const teeSelect = document.getElementById("tee-select");
      const courseSelect = document.getElementById("course-select");
      const courseResults = document.getElementById("course-search-results");
      const courseSearchBtn = document.getElementById("course-search-btn");
      const courseSearchQueryInput = document.getElementById("course-search-query");
      const COURSE_TEES = {{ course_tee_map | tojson }};
      const ALL_TEES = Object.values(COURSE_TEES).flat();

      if (teeSelect) {
        const placeholder = teeSelect.querySelector('option[value=""]')?.cloneNode(true);
        let storedTee = teeSelect.dataset.selectedTee || teeSelect.value || "";

        const renderTees = (courseId) => {
          teeSelect.innerHTML = "";
          if (placeholder) {
            teeSelect.append(placeholder.cloneNode(true));
          } else {
            const defaultOption = document.createElement("option");
            defaultOption.value = "";
            defaultOption.textContent = "-- Select tee --";
            teeSelect.append(defaultOption);
          }
          const teeList = courseId ? COURSE_TEES[courseId] || [] : ALL_TEES;
          teeList.forEach((tee) => {
            const option = document.createElement("option");
            option.value = tee.id;
            option.textContent = tee.label;
            option.dataset.course = tee.course_id;
            teeSelect.append(option);
          });
          const hasStored = teeList.some((tee) => tee.id === storedTee);
          teeSelect.value = hasStored ? storedTee : "";
        };

        teeSelect.addEventListener("change", (event) => {
          storedTee = event.target.value;
        });

        if (courseSelect) {
          courseSelect.addEventListener("change", () => {
            renderTees(courseSelect.value);
          });
          renderTees(courseSelect.value);
        } else {
          renderTees("");
        }
      }

      const formatCourseLocation = (course) => {
        const location = course.location || {};
        const city = location.city || course.city || "";
        const state = location.state || course.state || "";
        const country = location.country || course.country || "";
        const parts = [city, state, country].filter(Boolean);
        return parts.join(", ");
      };

      const renderResults = (courses) => {
        if (!courseResults) return;
        if (!courses.length) {
          courseResults.innerHTML = "<p class='status'>No courses found.</p>";
          return;
        }
        courseResults.innerHTML = courses
          .map(
            (course) => `
            <div class="course-result">
              <div>
                <strong>${course.club_name || ""}</strong>
                <p>${course.course_name || ""}</p>
                ${formatCourseLocation(course) ? `<p class="course-location">${formatCourseLocation(course)}</p>` : ""}
              </div>
              <button type="button" data-course-id="${course.id}" class="pill-link course-import-btn">Import</button>
            </div>
          `
          )
          .join("");
      };

      const searchCourses = async () => {
        if (!courseSearchQueryInput || !courseSearchQueryInput.value.trim()) return;
        courseResults.innerHTML = "<p class='status'>Searching…</p>";
        try {
          const response = await fetch(`/api/courses/search?query=${encodeURIComponent(courseSearchQueryInput.value.trim())}`);
          if (!response.ok) {
            courseResults.innerHTML = "<p class='status'>Search failed.</p>";
            return;
          }
          const data = await response.json();
          renderResults(data.courses || []);
        } catch (error) {
          courseResults.innerHTML = "<p class='status'>Search failed.</p>";
        }
      };

      if (courseSearchBtn) {
        courseSearchBtn.addEventListener("click", searchCourses);
      }

      document.addEventListener("click", async (event) => {
        if (!event.target.matches(".course-import-btn")) return;
        const courseId = event.target.getAttribute("data-course-id");
        if (!courseId) return;
        event.target.disabled = true;
        event.target.textContent = "Importing...";
        try {
          const response = await fetch(`/api/courses/import/${courseId}`, { method: "POST" });
          if (response.ok) {
            location.reload();
            return;
          }
          const data = await response.json().catch(() => ({}));
          event.target.textContent = data.detail ? `Failed: ${data.detail}` : "Import failed";
        } catch (error) {
          event.target.textContent = "Import failed";
        }
      });
    </script>
  {% endif %}
{% endblock %}
